{"version":3,"file":"BaseUpdater.js","sourceRoot":"","sources":["../src/BaseUpdater.ts"],"names":[],"mappings":"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","sourcesContent":["import { UpdateInfo, AllPublishOptions, CancellationError, DownloadOptions } from \"builder-util-runtime\"\nimport { ensureDir, rename, unlink } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { AppUpdater } from \"./AppUpdater\"\nimport { DOWNLOAD_PROGRESS, ResolvedUpdateFileInfo, UPDATE_DOWNLOADED } from \"./main\"\n\nexport abstract class BaseUpdater extends AppUpdater {\n  protected quitAndInstallCalled = false\n  private quitHandlerAdded = false\n\n  protected constructor(options?: AllPublishOptions | null, app?: any) {\n    super(options, app)\n  }\n\n  async quitAndInstall(isSilent: boolean = false, isForceRunAfter: boolean = false): Promise<void> {\n    this._logger.info(`Install on explicit quitAndInstall`)\n    const isInstalled = await this.install(isSilent, isSilent ? isForceRunAfter : true)\n    if (isInstalled) {\n      setImmediate(() => {\n        if (this.app.quit !== undefined) {\n          this.app.quit()\n        }\n      })\n    } else {\n      this.quitAndInstallCalled = false\n    }\n  }\n\n  protected async executeDownload(taskOptions: DownloadExecutorTask): Promise<Array<string>> {\n    if (this.listenerCount(DOWNLOAD_PROGRESS) > 0) {\n      taskOptions.downloadOptions.onProgress = it => this.emit(DOWNLOAD_PROGRESS, it)\n    }\n\n    const updateInfo = taskOptions.updateInfo\n    const version = updateInfo.version\n    const fileInfo = taskOptions.fileInfo\n    const packageInfo = fileInfo.packageInfo\n\n    const cacheDir = this.downloadedUpdateHelper.cacheDir\n    await ensureDir(cacheDir)\n    const updateFileName = taskOptions.fileExtension === \"AppImage\" ? path.basename(updateInfo.path) : `installer-${version}.${taskOptions.fileExtension}`\n    const updateFile = path.join(cacheDir, updateFileName)\n    const packageFile = packageInfo == null ? null : path.join(cacheDir, `package-${version}.${path.extname(packageInfo.path) || \"7z\"}`)\n\n    const done = () => {\n      this.downloadedUpdateHelper.setDownloadedFile(updateFile, packageFile, updateInfo, fileInfo)\n      this.addQuitHandler()\n      this.emit(UPDATE_DOWNLOADED, updateInfo)\n      return packageFile == null ? [updateFile] : [updateFile, packageFile]\n    }\n\n    const log = this._logger\n    if (await this.downloadedUpdateHelper.validateDownloadedPath(updateFile, updateInfo, fileInfo, log)) {\n      return done()\n    }\n\n    const removeFileIfAny = () => {\n      this.downloadedUpdateHelper.clear()\n      return unlink(updateFile)\n        .catch(() => {\n          // ignored\n        })\n    }\n\n    // https://github.com/electron-userland/electron-builder/pull/2474#issuecomment-366481912\n    let nameCounter = 0\n    let tempUpdateFile = path.join(cacheDir, `temp-${updateFileName}`)\n    for (let i = 0; i < 3; i++) {\n      try {\n        await unlink(tempUpdateFile)\n      }\n      catch (e) {\n        if (e.code === \"ENOENT\") {\n          break\n        }\n\n        log.warn(`Error on remove temp update file: ${e}`)\n        tempUpdateFile = path.join(cacheDir, `temp-${nameCounter++}-${updateFileName}`)\n      }\n    }\n\n    try {\n      await taskOptions.task(tempUpdateFile, packageFile, removeFileIfAny)\n      await rename(tempUpdateFile, updateFile)\n    }\n    catch (e) {\n      await removeFileIfAny()\n\n      if (e instanceof CancellationError) {\n        log.info(\"Cancelled\")\n        this.emit(\"update-cancelled\", updateInfo)\n      }\n      throw e\n    }\n\n    log.info(`New version ${version} has been downloaded to ${updateFile}`)\n    return done()\n  }\n\n  protected abstract doInstall(installerPath: string, isSilent: boolean, isRunAfter: boolean): boolean\n\n  protected async install(isSilent: boolean, isRunAfter: boolean): Promise<boolean> {\n    if (this.quitAndInstallCalled) {\n      this._logger.warn(\"install call ignored: quitAndInstallCalled is set to true\")\n      return false\n    }\n\n    const installerPath = this.downloadedUpdateHelper.file\n    // todo check (for now it is ok to no check as before, cached (from previous launch) update file checked in any case)\n    // const isValid = await this.isUpdateValid(installerPath)\n    if (installerPath == null) {\n      this.dispatchError(new Error(\"No valid update available, can't quit and install\"))\n      return false\n    }\n\n    // prevent calling several times\n    this.quitAndInstallCalled = true\n\n    try {\n      this._logger.info(`Install: isSilent: ${isSilent}, isRunAfter: ${isRunAfter}`)\n      return this.doInstall(installerPath, isSilent, isRunAfter)\n    }\n    catch (e) {\n      this.dispatchError(e)\n      return false\n    }\n  }\n\n  protected addQuitHandler() {\n    if (this.quitHandlerAdded || !this.autoInstallOnAppQuit) {\n      return\n    }\n\n    this.quitHandlerAdded = true\n\n    this.app.once(\"quit\", async () => {\n      if (!this.quitAndInstallCalled) {\n        this._logger.info(\"Auto install update on quit\")\n        await this.install(true, false)\n      } else {\n        this._logger.info(\"Update installer has already been triggered. Quitting application.\")\n      }\n    })\n  }\n}\n\nexport interface DownloadExecutorTask {\n  readonly fileExtension: string\n  readonly downloadOptions: DownloadOptions\n  readonly fileInfo: ResolvedUpdateFileInfo\n  readonly updateInfo: UpdateInfo\n  readonly task: (destinationFile: string, packageFile: string | null, removeTempDirIfAny: () => Promise<any>) => Promise<any>\n}\n"]}
