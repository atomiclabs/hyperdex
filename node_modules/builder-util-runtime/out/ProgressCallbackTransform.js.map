{"version":3,"file":"ProgressCallbackTransform.js","sourceRoot":"","sources":["../src/ProgressCallbackTransform.ts"],"names":[],"mappings":";;;;;;;AAAA,AAAO,AAAE,AAAS,AAAE,AAAM,AAAQ,AAWlC,AAAM;;;;;;;;;;MAAiC,kCAAQ,AAAS;AAOtD,cAA6B,AAAa,OAAmB,AAAoC,mBAAmB,AAAuC;AACzJ,AAAK,AAAE;AADoB,SAAK,QAAL,AAAK,AAAQ;AAAmB,SAAiB,oBAAjB,AAAiB,AAAmB;AAAmB,SAAU,aAAV,AAAU,AAA6B;AANnJ,SAAK,QAAG,AAAI,KAAC,AAAG,AAAE;AAClB,SAAW,cAAG,AAAC;AACf,SAAK,QAAG,AAAC;AAET,SAAU,aAAG,AAAI,KAAC,AAAK,QAAG,AAAI,AAItC;AAAC;;AAED,AAAU,aAAC,AAAU,OAAE,AAAgB,UAAE,AAAa;AACpD,QAAI,AAAI,KAAC,AAAiB,kBAAC,AAAS,WAAE;AACpC,AAAQ,eAAC,IAAI,AAAK,MAAC,AAAW,AAAC,cAAE,AAAI,AAAC;AACtC,AAAM;AACP;;AAED,AAAI,SAAC,AAAW,eAAI,AAAK,MAAC,AAAM;AAChC,AAAI,SAAC,AAAK,SAAI,AAAK,MAAC,AAAM;AAE1B,UAAM,AAAG,MAAG,AAAI,KAAC,AAAG,AAAE;;AACtB,QAAI,AAAG,OAAI,AAAI,KAAC,AAAU,cAAI,AAAI,KAAC,AAAW,gBAAK,AAAI,KAAC,AAAK;AAAC,AAA+B;MAAE;AAC7F,AAAI,aAAC,AAAU,aAAG,AAAG,MAAG,AAAI;AAE5B,AAAI,aAAC,AAAU;AACb,AAAK,iBAAE,AAAI,KAAC,AAAK;AACjB,AAAK,iBAAE,AAAI,KAAC,AAAK;AACjB,AAAW,uBAAE,AAAI,KAAC,AAAW;AAC7B,AAAO,mBAAG,AAAI,KAAC,AAAW,cAAG,AAAI,KAAC,AAAK,AAAC,KAA/B,GAAkC,AAAG;AAC9C,AAAc,0BAAE,AAAI,KAAC,AAAK,MAAC,AAAI,KAAC,AAAW,AAAG,eAAC,CAAC,AAAG,MAAG,AAAI,KAAC,AAAK,AAAC,SAAG,AAAI,AAAC,AAAC,AAC3E,AAAC;AANc;AAOhB,AAAI,aAAC,AAAK,QAAG,AAAC;AACf;;AAED,AAAQ,aAAC,AAAI,MAAE,AAAK,AAAC,AACvB;AAAC;;AAED,AAAM,SAAC,AAAa;AAClB,QAAI,AAAI,KAAC,AAAiB,kBAAC,AAAS,WAAE;AACpC,AAAQ,eAAC,IAAI,AAAK,MAAC,AAAW,AAAC,AAAC;AAChC,AAAM;AACP;;AAED,AAAI,SAAC,AAAU;AACb,AAAK,aAAE,AAAI,KAAC,AAAK;AACjB,AAAK,aAAE,AAAI,KAAC,AAAK;AACjB,AAAW,mBAAE,AAAI,KAAC,AAAK;AACvB,AAAO,eAAE,AAAG;AACZ,AAAc,sBAAE,AAAI,KAAC,AAAK,MAAC,AAAI,KAAC,AAAW,AAAG,eAAC,CAAC,AAAI,KAAC,AAAG,AAAE,QAAG,AAAI,KAAC,AAAK,AAAC,SAAG,AAAI,AAAC,AAAC,AAClF,AAAC;AANc;AAOhB,AAAI,SAAC,AAAK,QAAG,AAAC;AAEd,AAAQ,aAAC,AAAI,AAAC,AAChB;AAAC,AACF","sourcesContent":["import { Transform } from \"stream\"\nimport { CancellationToken } from \"./CancellationToken\"\n\nexport interface ProgressInfo {\n  total: number\n  delta: number\n  transferred: number\n  percent: number\n  bytesPerSecond: number\n}\n\nexport class ProgressCallbackTransform extends Transform {\n  private start = Date.now()\n  private transferred = 0\n  private delta = 0\n\n  private nextUpdate = this.start + 1000\n\n  constructor(private readonly total: number, private readonly cancellationToken: CancellationToken, private readonly onProgress: (info: ProgressInfo) => any) {\n    super()\n  }\n\n  _transform(chunk: any, encoding: string, callback: any) {\n    if (this.cancellationToken.cancelled) {\n      callback(new Error(\"Cancelled\"), null)\n      return\n    }\n\n    this.transferred += chunk.length\n    this.delta += chunk.length\n\n    const now = Date.now()\n    if (now >= this.nextUpdate && this.transferred !== this.total /* will be emitted on _flush */) {\n      this.nextUpdate = now + 1000\n\n      this.onProgress({\n        total: this.total,\n        delta: this.delta,\n        transferred: this.transferred,\n        percent: (this.transferred / this.total) * 100,\n        bytesPerSecond: Math.round(this.transferred / ((now - this.start) / 1000))\n      })\n      this.delta = 0\n    }\n\n    callback(null, chunk)\n  }\n\n  _flush(callback: any): void {\n    if (this.cancellationToken.cancelled) {\n      callback(new Error(\"Cancelled\"))\n      return\n    }\n\n    this.onProgress({\n      total: this.total,\n      delta: this.delta,\n      transferred: this.total,\n      percent: 100,\n      bytesPerSecond: Math.round(this.transferred / ((Date.now() - this.start) / 1000))\n    })\n    this.delta = 0\n\n    callback(null)\n  }\n}\n"]}
