{"version":3,"file":"fs.js","sourceRoot":"","sources":["../src/fs.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { access, chmod, copyFile as _nodeCopyFile, createReadStream, createWriteStream, ensureDir, link, lstat, readdir, readlink, stat, Stats, symlink, unlink, writeFile } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport Mode from \"stat-mode\"\nimport { log } from \"./log\"\nimport { orNullIfFileNotExist } from \"./promise\"\n\nexport const MAX_FILE_REQUESTS = 8\nexport const CONCURRENCY = {concurrency: MAX_FILE_REQUESTS}\n\nexport type FileTransformer = (path: string) => Promise<null | string | Buffer> | null | string | Buffer\nexport type Filter = (file: string, stat: Stats) => boolean\n\nexport function unlinkIfExists(file: string) {\n  return unlink(file)\n    .catch(() => {/* ignore */})\n}\n\nexport async function statOrNull(file: string): Promise<Stats | null> {\n  return orNullIfFileNotExist(stat(file))\n}\n\nexport async function exists(file: string): Promise<boolean> {\n  try {\n    await access(file)\n    return true\n  }\n  catch (e) {\n    return false\n  }\n}\n\nexport interface FileConsumer {\n  consume(file: string, fileStat: Stats, parent: string, siblingNames: Array<string>): any\n\n  /**\n   * @default false\n   */\n  isIncludeDir?: boolean\n}\n\n/**\n * Returns list of file paths (system-dependent file separator)\n */\nexport async function walk(initialDirPath: string, filter?: Filter | null, consumer?: FileConsumer): Promise<Array<string>> {\n  let result: Array<string> = []\n  const queue: Array<string> = [initialDirPath]\n  let addDirToResult = false\n  const isIncludeDir = consumer == null ? false : consumer.isIncludeDir === true\n  while (queue.length > 0) {\n    const dirPath = queue.pop()!\n    if (isIncludeDir) {\n      if (addDirToResult) {\n        result.push(dirPath)\n      }\n      else {\n        addDirToResult = true\n      }\n    }\n\n    const childNames = await readdir(dirPath)\n    childNames.sort()\n\n    let nodeModuleContent: Array<string> | null = null\n\n    const dirs: Array<string> = []\n    // our handler is async, but we should add sorted files, so, we add file to result not in the mapper, but after map\n    const sortedFilePaths = await BluebirdPromise.map(childNames, name => {\n      if (name === \".DS_Store\" || name === \".gitkeep\") {\n        return null\n      }\n\n      const filePath = dirPath + path.sep + name\n      return lstat(filePath)\n        .then(stat => {\n          if (filter != null && !filter(filePath, stat)) {\n            return null\n          }\n\n          const consumerResult = consumer == null ? null : consumer.consume(filePath, stat, dirPath, childNames)\n          if (consumerResult == null || !(\"then\" in consumerResult)) {\n            if (stat.isDirectory()) {\n              dirs.push(name)\n              return null\n            }\n            else {\n              return filePath\n            }\n          }\n          else {\n            return (consumerResult as Promise<any>)\n              .then((it): any => {\n                if (it != null && Array.isArray(it)) {\n                  nodeModuleContent = it\n                  return null\n                }\n\n                // asarUtil can return modified stat (symlink handling)\n                if ((it != null && \"isDirectory\" in it ? (it as Stats) : stat).isDirectory()) {\n                  dirs.push(name)\n                  return null\n                }\n                else {\n                  return filePath\n                }\n              })\n          }\n        })\n    }, CONCURRENCY)\n\n    for (const child of sortedFilePaths) {\n      if (child != null) {\n        result.push(child)\n      }\n    }\n\n    dirs.sort()\n    for (const child of dirs) {\n      queue.push(dirPath + path.sep + child)\n    }\n\n    if (nodeModuleContent != null) {\n      result = result.concat(nodeModuleContent)\n    }\n  }\n\n  return result\n}\n\nconst _isUseHardLink = process.platform !== \"win32\" && process.env.USE_HARD_LINKS !== \"false\" && (require(\"is-ci\") || process.env.USE_HARD_LINKS === \"true\")\n\nexport function copyFile(src: string, dest: string, isEnsureDir = true) {\n  return (isEnsureDir ? ensureDir(path.dirname(dest)) : Promise.resolve())\n    .then(() => copyOrLinkFile(src, dest, null, false))\n}\n\n/**\n * Hard links is used if supported and allowed.\n * File permission is fixed — allow execute for all if owner can, allow read for all if owner can.\n *\n * ensureDir is not called, dest parent dir must exists\n */\nexport function copyOrLinkFile(src: string, dest: string, stats?: Stats | null, isUseHardLink = _isUseHardLink, exDevErrorHandler?: (() => boolean) | null): Promise<any> {\n  if (stats != null) {\n    const originalModeNumber = stats.mode\n    const mode = new Mode(stats)\n    if (mode.owner.execute) {\n      mode.group.execute = true\n      mode.others.execute = true\n    }\n\n    mode.group.read = true\n    mode.others.read = true\n\n    if (originalModeNumber !== stats.mode) {\n      if (log.isDebugEnabled) {\n        const oldMode = new Mode({mode: originalModeNumber})\n        log.debug({file: dest, oldMode, mode}, \"permissions fixed from\")\n      }\n\n      // https://helgeklein.com/blog/2009/05/hard-links-and-permissions-acls/\n      // Permissions on all hard links to the same data on disk are always identical. The same applies to attributes.\n      // That means if you change the permissions/owner/attributes on one hard link, you will immediately see the changes on all other hard links.\n      if (isUseHardLink) {\n        isUseHardLink = false\n        log.debug({dest}, \"copied, but not linked, because file permissions need to be fixed\")\n      }\n    }\n  }\n\n  if (isUseHardLink) {\n    return link(src, dest)\n      .catch(e => {\n        if (e.code === \"EXDEV\") {\n          const isLog = exDevErrorHandler == null ? true : exDevErrorHandler()\n          if (isLog && log.isDebugEnabled) {\n            log.debug({error: e.message}, \"cannot copy using hard link\")\n          }\n          return doCopyFile(src, dest, stats)\n        }\n        else {\n          throw e\n        }\n      })\n  }\n  return doCopyFile(src, dest, stats)\n}\n\nfunction doCopyFile(src: string, dest: string, stats: Stats | null | undefined): Promise<any> {\n  if (_nodeCopyFile == null) {\n    return new BluebirdPromise((resolve, reject) => {\n      const reader = createReadStream(src)\n      const writer = createWriteStream(dest, stats == null ? undefined : {mode: stats!!.mode})\n      reader.on(\"error\", reject)\n      writer.on(\"error\", reject)\n      writer.on(\"open\", () => {\n        reader.pipe(writer)\n      })\n      writer.once(\"close\", resolve)\n    })\n  }\n\n  // node 8.5.0+\n  const promise = _nodeCopyFile(src, dest)\n  if (stats == null) {\n    return promise\n  }\n\n  return promise\n    .then(() => chmod(dest, stats.mode))\n}\n\nexport class FileCopier {\n  isUseHardLink: boolean\n\n  constructor(private readonly isUseHardLinkFunction?: (file: string) => boolean, private readonly transformer?: FileTransformer | null) {\n    if (isUseHardLinkFunction === USE_HARD_LINKS) {\n      this.isUseHardLink = true\n    }\n    else {\n      this.isUseHardLink = _isUseHardLink && isUseHardLinkFunction !== DO_NOT_USE_HARD_LINKS\n    }\n  }\n\n  async copy(src: string, dest: string, stat: Stats | undefined) {\n    if (this.transformer != null && stat != null && stat.isFile()) {\n      let data = this.transformer(src)\n      if (data != null) {\n        if (typeof (data as any).then === \"function\") {\n          data = await data\n        }\n\n        if (data != null) {\n          await writeFile(dest, data)\n          return\n        }\n      }\n    }\n    const isUseHardLink = (!this.isUseHardLink || this.isUseHardLinkFunction == null) ? this.isUseHardLink : this.isUseHardLinkFunction(dest)\n    await copyOrLinkFile(src, dest, stat, isUseHardLink, isUseHardLink ? () => {\n      // files are copied concurrently, so, we must not check here currentIsUseHardLink — our code can be executed after that other handler will set currentIsUseHardLink to false\n      if (this.isUseHardLink) {\n        this.isUseHardLink = false\n        return true\n      }\n      else {\n        return false\n      }\n    } : null)\n  }\n}\n\nexport interface CopyDirOptions {\n  filter?: Filter | null\n  transformer?: FileTransformer | null\n  isUseHardLink?: (file: string) => boolean\n}\n\n/**\n * Empty directories is never created.\n * Hard links is used if supported and allowed.\n */\nexport function copyDir(src: string, destination: string, options: CopyDirOptions = {}): Promise<any> {\n  const fileCopier = new FileCopier(options.isUseHardLink, options.transformer)\n\n  if (log.isDebugEnabled) {\n    log.debug({src, destination}, `copying${fileCopier.isUseHardLink ? \" using hard links\" : \"\"}`)\n  }\n\n  const createdSourceDirs = new Set<string>()\n  const links: Array<Link> = []\n  return walk(src, options.filter, {\n    consume: async (file, stat, parent) => {\n      if (!stat.isFile() && !stat.isSymbolicLink()) {\n        return\n      }\n\n      if (!createdSourceDirs.has(parent)) {\n        await ensureDir(parent.replace(src, destination))\n        createdSourceDirs.add(parent)\n      }\n\n      const destFile = file.replace(src, destination)\n      if (stat.isFile()) {\n        await fileCopier.copy(file, destFile, stat)\n      }\n      else {\n        links.push({file: destFile, link: await readlink(file)})\n      }\n    }\n  })\n    .then(() => BluebirdPromise.map(links, it => symlink(it.link, it.file), CONCURRENCY))\n}\n\nexport const DO_NOT_USE_HARD_LINKS = (file: string) => false\nexport const USE_HARD_LINKS = (file: string) => true\n\nexport interface Link {\n  readonly link: string,\n  readonly file: string\n}"]}
