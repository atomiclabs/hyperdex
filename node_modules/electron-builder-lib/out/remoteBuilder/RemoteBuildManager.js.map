{"version":3,"file":"RemoteBuildManager.js","sourceRoot":"","sources":["../../src/remoteBuilder/RemoteBuildManager.ts"],"names":[],"mappings":"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","sourcesContent":["import { path7za } from \"7zip-bin\"\nimport BluebirdPromise from \"bluebird-lst\"\nimport { Arch, isEnvTrue, log, spawn as _spawn } from \"builder-util\"\nimport { HttpError } from \"builder-util-runtime\"\nimport { spawn } from \"child_process\"\nimport { UploadTask } from \"electron-publish\"\nimport { outputFile } from \"fs-extra-p\"\nimport { ClientHttp2Session, ClientHttp2Stream, connect, constants, OutgoingHttpHeaders, SecureClientSessionOptions } from \"http2\"\nimport * as path from \"path\"\nimport { URL } from \"url\"\nimport { Target, TargetSpecificOptions } from \"../core\"\nimport { ArtifactCreated } from \"../packagerApi\"\nimport { PlatformPackager } from \"../platformPackager\"\nimport { getAria, getZstd } from \"../targets/tools\"\nimport { JsonStreamParser } from \"../util/JsonStreamParser\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { DevTimer } from \"../util/timer\"\nimport { ProjectInfoManager } from \"./ProjectInfoManager\"\nimport { ELECTRON_BUILD_SERVICE_CA_CERT, ELECTRON_BUILD_SERVICE_LOCAL_CA_CERT } from \"./remote-builder-certs\"\nimport { RemoteBuilderResponse } from \"./RemoteBuilder\"\n\nconst {\n  HTTP2_HEADER_PATH,\n  HTTP2_METHOD_POST,\n  HTTP2_METHOD_GET,\n  HTTP2_HEADER_METHOD,\n  HTTP2_HEADER_CONTENT_TYPE,\n  HTTP2_HEADER_STATUS,\n  HTTP_STATUS_OK,\n  HTTP_STATUS_BAD_REQUEST\n} = constants\n\nconst isUseLocalCert = isEnvTrue(process.env.USE_ELECTRON_BUILD_SERVICE_LOCAL_CA)\n\nexport function getConnectOptions(): SecureClientSessionOptions {\n  const options: SecureClientSessionOptions = {}\n  const caCert = process.env.ELECTRON_BUILD_SERVICE_CA_CERT\n  if (caCert !== \"false\") {\n    if (isUseLocalCert) {\n      log.debug(null, \"local certificate authority is used\")\n    }\n    options.ca = caCert || (isUseLocalCert ? ELECTRON_BUILD_SERVICE_LOCAL_CA_CERT : ELECTRON_BUILD_SERVICE_CA_CERT)\n    // we cannot issue cert per IP because build agent can be started on demand (and for security reasons certificate authority is offline).\n    // Since own certificate authority is used, it is ok to skip server name verification.\n    options.checkServerIdentity = () => undefined\n  }\n  return options\n}\n\nexport class RemoteBuildManager {\n  private readonly client: ClientHttp2Session\n\n  private files: Array<ArtifactInfo> | null = null\n  private finishedStreamCount = 0\n\n  constructor(private readonly buildServiceEndpoint: string,\n              private readonly projectInfoManager: ProjectInfoManager,\n              private readonly unpackedDirectory: string,\n              private readonly outDir: string,\n              private readonly packager: PlatformPackager<any>) {\n    log.debug({endpoint: buildServiceEndpoint}, \"connect to remote build service\")\n    this.client = connect(buildServiceEndpoint, getConnectOptions())\n  }\n\n  build(customHeaders: OutgoingHttpHeaders): Promise<RemoteBuilderResponse | null> {\n    return new BluebirdPromise<RemoteBuilderResponse | null>((resolve, reject) => {\n      const client = this.client\n      client.on(\"socketError\", reject)\n      client.on(\"error\", reject)\n\n      let handled = false\n      client.once(\"close\", () => {\n        if (!handled) {\n          reject(new Error(\"Closed unexpectedly\"))\n        }\n      })\n      client.once(\"timeout\", () => {\n        reject(new Error(\"Timeout\"))\n      })\n\n      this.doBuild(customHeaders)\n        .then(result => {\n          handled = true\n          resolve(result)\n        })\n        .catch(reject)\n    })\n      .finally(() => {\n        this.client.destroy()\n      })\n  }\n\n  private async doBuild(customHeaders: OutgoingHttpHeaders): Promise<RemoteBuilderResponse | null> {\n    const id = await this.upload(customHeaders)\n    const result = await this.listenEvents(id)\n    await new BluebirdPromise((resolve, reject) => {\n      const stream = this.client.request({\n        [HTTP2_HEADER_PATH]: `/v1/complete/${id}`,\n        [HTTP2_HEADER_METHOD]: HTTP2_METHOD_GET,\n      })\n      stream.on(\"error\", reject)\n      stream.on(\"response\", headers => {\n        try {\n          const status = headers[HTTP2_HEADER_STATUS] as any\n          if (!checkStatus(status, reject)) {\n            log.warn(`Not critical server error: ${status}`)\n          }\n        }\n        finally {\n          resolve()\n        }\n      })\n    })\n\n    return result\n  }\n\n  private upload(customHeaders: OutgoingHttpHeaders): Promise<string> {\n    return new BluebirdPromise((resolve, reject) => {\n      const zstdCompressionLevel = getZstdCompressionLevel(this.buildServiceEndpoint)\n\n      const stream = this.client.request({\n        [HTTP2_HEADER_PATH]: \"/v1/upload\",\n        [HTTP2_HEADER_METHOD]: HTTP2_METHOD_POST,\n        [HTTP2_HEADER_CONTENT_TYPE]: \"application/octet-stream\",\n        ...customHeaders,\n        // only for stats purpose, not required for build\n        \"x-zstd-compression-level\": zstdCompressionLevel,\n      })\n      stream.on(\"error\", reject)\n      // this.handleStreamEvent(resolve, reject)\n      this.uploadUnpackedAppArchive(stream, zstdCompressionLevel, reject)\n\n      stream.on(\"response\", headers => {\n        const status: number = headers[HTTP2_HEADER_STATUS] as any\n        if (status !== HTTP_STATUS_OK && status !== HTTP_STATUS_BAD_REQUEST) {\n          reject(new HttpError(status))\n          return\n        }\n\n        let data = \"\"\n        stream.setEncoding(\"utf8\")\n        stream.on(\"data\", (chunk: string) => {\n          data += chunk\n        })\n        stream.on(\"end\", () => {\n          const result = data.length === 0 ? {} : JSON.parse(data)\n          log.debug({result: JSON.stringify(result, null, 2)}, `remote builder result`)\n\n          if (status === HTTP_STATUS_BAD_REQUEST) {\n            reject(new HttpError(status, JSON.stringify(result, null, 2)))\n            return\n          }\n\n          const id = result.id\n          if (id == null) {\n            reject(new Error(\"Server didn't return id\"))\n            return\n          }\n\n          // cannot connect immediately because channel status is not yet created\n          resolve(id)\n        })\n      })\n    })\n  }\n\n  private listenEvents(id: string): Promise<RemoteBuilderResponse | null> {\n    return new BluebirdPromise((resolve, reject) => {\n      const stream = this.client.request({\n        [HTTP2_HEADER_PATH]: `/v1/status/${id}`,\n        [HTTP2_HEADER_METHOD]: HTTP2_METHOD_GET,\n      })\n      stream.on(\"error\", reject)\n      stream.on(\"response\", headers => {\n        if (!checkStatus(headers[HTTP2_HEADER_STATUS] as any, reject)) {\n          return\n        }\n\n        stream.setEncoding(\"utf8\")\n        const eventSource = new JsonStreamParser(data => {\n          if (log.isDebugEnabled) {\n            log.debug({event: JSON.stringify(data, null, 2)}, \"remote builder event\")\n          }\n\n          const error = data.error\n          if (error != null) {\n            stream.destroy()\n            resolve(data)\n            return\n          }\n\n          if (data.state != null) {\n            let message = data.state\n            switch (data.state) {\n              case \"added\":\n                message = \"job added to build queue\"\n                break\n\n              case \"started\":\n                message = \"job started\"\n                break\n            }\n            log.info({status: message}, \"remote building\")\n            return\n          }\n\n          if (!(\"files\" in data)) {\n            log.warn(`Unknown builder event: ${JSON.stringify(data)}`)\n            return\n          }\n\n          // close, no more events are expected\n          stream.destroy()\n\n          this.files = data.files\n          for (const artifact of this.files!!) {\n            log.info({file: artifact.file}, `downloading remote build artifact`)\n            this.downloadFile(id, artifact, resolve, reject)\n          }\n        })\n        stream.on(\"data\", (chunk: string) => eventSource.parseIncoming(chunk))\n      })\n    })\n  }\n\n  private downloadFile(id: string, artifact: ArtifactInfo, resolve: (result: RemoteBuilderResponse | null) => void, reject: (error: Error) => void) {\n    const downloadTimer = new DevTimer(\"compress and upload\")\n    const localFile = path.join(this.outDir, artifact.file)\n    const artifactCreatedEvent = this.artifactInfoToArtifactCreatedEvent(artifact, localFile)\n    // use URL to encode path properly (critical for filenames with unicode symbols, e.g. \"boo-Test App ßW\")\n    const fileUrlPath = `/v1/download${new URL(`f:/${id}/${artifact.file}`).pathname}`\n\n    const fileWritten = () => {\n      this.finishedStreamCount++\n      log.info({time: downloadTimer.endAndGet(), file: artifact.file}, \"downloaded remote build artifact\")\n      log.debug({file: localFile}, \"saved remote build artifact\")\n\n      // PublishManager uses outDir and options, real (the same as for local build) values must be used\n      this.projectInfoManager.packager.dispatchArtifactCreated(artifactCreatedEvent)\n\n      if (this.files != null && this.finishedStreamCount >= this.files.length) {\n        resolve(null)\n      }\n    }\n\n    const isShort = artifact.file.endsWith(\".yml\") || artifact.file.endsWith(\".json\")\n    if (!isShort) {\n      // --ca-certificate This option is only available when aria2 was compiled against GnuTLS or OpenSSL. WinTLS and AppleTLS will always use the system certificate store. Instead of `--ca-certificate install the certificate in that store.\n      // so, we have to use --check-certificate false\n      getAria()\n        .then(aria2c => {\n          return _spawn(aria2c, [\n            \"--max-connection-per-server=4\",\n            \"--min-split-size=5M\",\n            \"--retry-wait=3\",\n            `--ca-certificate=${getTemplatePath(isUseLocalCert ? \"local-ca.crt\" : \"ca.crt\")}`,\n            \"--check-certificate=false\",\n            \"--min-tls-version=TLSv1.2\",\n            \"--console-log-level=warn\",\n            \"--download-result=full\",\n            `--dir=${this.outDir}`,\n            `${this.buildServiceEndpoint}${fileUrlPath}`,\n          ], {\n            cwd: this.outDir,\n            stdio: [\"ignore\", \"inherit\", \"inherit\"],\n          })\n        })\n        .then(fileWritten)\n        .catch(reject)\n      return\n    }\n\n    const stream = this.client.request({\n      [HTTP2_HEADER_PATH]: fileUrlPath,\n      [HTTP2_HEADER_METHOD]: HTTP2_METHOD_GET,\n    })\n    stream.on(\"error\", reject)\n\n    stream.on(\"response\", headers => {\n      if (!checkStatus(headers[HTTP2_HEADER_STATUS] as any, reject)) {\n        return\n      }\n\n      const buffers: Array<Buffer> = []\n      stream.on(\"end\", () => {\n        const fileContent = buffers.length === 1 ? buffers[0] : Buffer.concat(buffers)\n        artifactCreatedEvent.fileContent = fileContent\n        outputFile(localFile, fileContent)\n          .then(fileWritten)\n          .catch(reject)\n      })\n      stream.on(\"data\", (chunk: Buffer) => {\n        buffers.push(chunk)\n      })\n    })\n  }\n\n  private artifactInfoToArtifactCreatedEvent(artifact: ArtifactInfo, localFile: string): ArtifactCreated {\n    const target = artifact.target\n    // noinspection SpellCheckingInspection\n    return {\n      ...artifact,\n      file: localFile,\n      target: target == null ? null : new FakeTarget(target, this.outDir, (this.packager.config as any)[target]),\n      packager: this.packager,\n    }\n  }\n\n  // compress and upload in the same time, directly to remote without intermediate local file\n  private uploadUnpackedAppArchive(stream: ClientHttp2Stream, zstdCompressionLevel: string, reject: (error: Error) => void) {\n    const packager = this.projectInfoManager.packager\n    const buildResourcesDir = packager.buildResourcesDir\n    if (buildResourcesDir === packager.projectDir) {\n      reject(new Error(`Build resources dir equals to project dir and so, not sent to remote build agent. It will lead to incorrect results.\\nPlease set \"directories.buildResources\" to separate dir or leave default (\"build\" directory in the project root)`))\n      return\n    }\n\n    Promise.all([this.projectInfoManager.infoFile.value, getZstd()])\n      .then(results => {\n        const infoFile = results[0]\n        log.info(\"compressing and uploading to remote builder\")\n        const compressAndUploadTimer = new DevTimer(\"compress and upload\")\n        // noinspection SpellCheckingInspection\n        const tarProcess = spawn(path7za, [\n          \"a\", \"dummy\", \"-ttar\", \"-so\",\n          this.unpackedDirectory,\n          infoFile,\n          buildResourcesDir,\n        ], {\n          stdio: [\"pipe\", \"pipe\", process.stderr],\n        })\n        tarProcess.stdout.on(\"error\", reject)\n\n        const zstdProcess = spawn(results[1], [`-${zstdCompressionLevel}`, \"--long\"], {\n          stdio: [\"pipe\", \"pipe\", process.stderr],\n        })\n        zstdProcess.on(\"error\", reject)\n        tarProcess.stdout.pipe(zstdProcess.stdin)\n        zstdProcess.stdout.pipe(stream)\n\n        zstdProcess.stdout.on(\"end\", () => {\n          log.info({time: compressAndUploadTimer.endAndGet()}, \"uploaded to remote builder\")\n        })\n      })\n      .catch(reject)\n  }\n}\n\nfunction getZstdCompressionLevel(endpoint: string): string {\n  const result = process.env.ELECTRON_BUILD_SERVICE_ZSTD_COMPRESSION\n  if (result != null) {\n    return result\n  }\n  // 18 - 40s\n  // 17 - 30s\n  // 16 - 20s\n  return endpoint.startsWith(\"https://127.0.0.1:\") || endpoint.startsWith(\"https://localhost:\") || endpoint.startsWith(\"[::1]:\") ? \"3\" : \"16\"\n}\n\nexport function checkStatus(status: number, reject: (error: Error) => void) {\n  if (status === HTTP_STATUS_OK) {\n    return true\n  }\n  else {\n    reject(new HttpError(status))\n    return false\n  }\n}\n\nclass FakeTarget extends Target {\n  constructor(name: string, readonly outDir: string, readonly options: TargetSpecificOptions | null | undefined) {\n    super(name)\n  }\n\n  async build(appOutDir: string, arch: Arch) {\n    // no build\n  }\n}\n\nexport interface ArtifactInfo extends UploadTask {\n  target: string | null\n\n  readonly isWriteUpdateInfo?: boolean\n  readonly updateInfo?: any\n}"]}
