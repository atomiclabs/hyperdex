{"version":3,"file":"pkg.js","sourceRoot":"","sources":["../../src/targets/pkg.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA,AAAO,AAAQ,AAAK,AAAE,AAAI,AAAE,AAAG,AAAE,AAAM,AAAc;;;;;;;;;;AACrD,AAAO,AAAE,AAAU,AAAE,AAAM,AAAqB;;;;;;;;;;AAChD,AAAO,AAAE,AAA2B,AAAE,AAAM,AAA0B;;;;;;;;;;AACtE,AAAO,AAAE,AAAQ,AAAE,AAAM,AAAE,AAAS,AAAE,AAAM,AAAY;;;;;;;;;;AACxD,AAAO,AAAK,AAAI,AAAM,AAAM;;AAE5B,AAAO,AAAE,AAAwB,AAAE,AAAM,AAAY;;;;;;;;;;AACrD,AAAO,AAAE,AAAY,AAAY,AAAM,AAAa;;;;;;;;;;AACpD,AAAO,AAAE,AAAM,AAAE,AAAM,AAAS;;;;;;;;;;;;AAGhC,MAAM,AAAQ,WAAG,AAAwB,0BAEzC,AAAkE;AAClE,AAAwE;AACxE,AAA8F;AAC9F,AAA0F,AAC1F,AAAM;;MAAiB,kBAAQ,AAAM;AAQnC,cAA6B,AAAqB,UAAW,AAAc;AACzE,AAAK,UAAC,AAAK,AAAC;AADe,SAAQ,WAAR,AAAQ,AAAa;AAAW,SAAM,SAAN,AAAM,AAAQ;AAPlE,SAAO;AACd,AAAa,qBAAE,AAAI;AACnB,AAAoB,4BAAE,AAAI;AAC1B,AAAkB,0BAAE,AAAI;OACrB,AAAI,KAAC,AAAQ,SAAC,AAAM,OAAC,AAAG,AAC5B,AAID;AAAC;;AAEK,AAAK,OAAX,AAAK,CAAO,AAAe,SAAE,AAAU;;;;AACrC,YAAM,AAAQ,WAAG,AAAI,MAAC,AAAQ;AAC9B,YAAM,AAAO,UAAG,AAAI,MAAC,AAAO;AAC5B,YAAM,AAAO,UAAG,AAAQ,SAAC,AAAO;AAEhC,YAAM,AAAY,eAAG,AAAQ,SAAC,AAAyB,0BAAC,AAAO,SAAE,AAAK,AAAC;AACvE,YAAM,AAAY,eAAG,AAAI,KAAC,AAAI,KAAC,AAAI,MAAC,AAAM,QAAE,AAAY,AAAC;;AAEzD,AAAI,YAAC,AAAW,YAAC,AAAK,OAAE,AAAY,cAAE,AAAI,AAAC;;AAE3C,YAAM,AAAY,eAAG,CAAC,MAAM,AAAQ,SAAC,AAAe,gBAAC,AAAK,AAAC,OAAC,AAAY;AAExE,YAAM,AAAS,YAAG,AAAI,MAAC,AAAM,QAC7B,AAAkJ;;AAClJ,YAAM,AAAY,eAAG,AAAI,KAAC,AAAI,KAAC,AAAS,WAAE,AAAkB,AAAC;AAE7D,YAAM,AAAgB,mBAAG,AAAI,KAAC,AAAI,KAAC,AAAS,AAAE,cAAG,AAAwB,yCAAC,AAAO,QAAC,AAAE,AAAC,GAAM,AAAC;AAC5F,YAAM,AAAQ,WAAG,CAAC,MAAM,AAAO,QAAC,AAAG,IAAC,CAClC,AAAY,8BAAC,AAAQ,UAAE,AAAO,QAAC,AAAQ,YAAI,AAAQ,SAAC,AAA4B,6BAAC,AAAQ,UAAE,AAAY,AAAC,eACxG,AAAI,MAAC,AAAkC,mCAAC,AAAY,cAAE,AAAO,AAAC,UAC9D,AAAI,MAAC,AAAqB,sBAAC,AAAO,SAAE,AAAgB,AAAC,AACtD,AAAC,AAAC,qBAAC,AAAC,AAAC;;AAEN,UAAI,AAAQ,YAAI,AAAI,QAAI,AAAQ,SAAC,AAAgB,kBAAE;AACjD,cAAM,IAAI,AAAK,AAAC,4BAAsB,AAAQ,QAAgF,AAAC;AAChI;;AAED,YAAM,AAAI,OAAG,AAAuB,wBAAC,AAAQ,UAAE,AAAY,AAAC;AAC5D,AAAI,WAAC,AAAI,KAAC,AAAgB,kBAAE,AAAY,AAAC;AACzC,AAAI,WAAC,AAAI,KAAC,AAAY,AAAC;AACvB,AAAG,8BAAC,AAAO,QAAC,AAAY,cAAE,AAAE,AAAC,AAAE,MAAC,AAAI,KAAC,AAAI,KAAC,GAAG,AAAS,AAAC,AAAC;AACxD,qCAAW,AAAc,gBAAE,AAAI;AAC7B,AAAG,aAAE,AAAS,AACf,AAAC;AAF+B,OAA3B,AAAI;AAGV,YAAM,AAAO,QAAC,AAAG,IAAC,CAAC,AAAM,wBAAC,AAAgB,AAAC,mBAAE,AAAM,wBAAC,AAAY,AAAC,AAAC,AAAC;AAEnE,AAAQ,eAAC,AAAuB,wBAAC,AAAY,cAAE,AAAI,OAAE,AAAI,MAAE,AAAQ,SAAC,AAAuB,wBAAC,AAAY,cAAE,AAAK,OAAE,AAAI,AAAC,AAAC,AACzH;;AAAC;;AAEa,AAAkC,oCAAxC,AAAK,CAAoC,AAAoB,cAAE,AAAe;;;;AACpF,qCAAW,AAAc,gBAAE,CAAC,AAAc,gBAAE,AAAa,eAAE,AAAO,SAAE,AAAY,AAAC;AAC/E,AAAG,aAAE,AAAI,OAAC,AAAM,AACjB,AAAC;AAFiF,OAA7E,AAAI;AAIV,YAAM,AAAO,UAAG,AAAI,OAAC,AAAO;AAC5B,UAAI,AAAQ,WAAG,MAAM,AAAQ,0BAAC,AAAY,cAAE,AAAO,AAAC;AACpD,YAAM,AAAW,cAAG,AAAQ,SAAC,AAAW,YAAC,AAAyB,AAAC;AACnE,AAAQ,iBAAG,AAAQ,SAAC,AAAS,UAAC,AAAC,GAAE,AAAW,AAAC,AAAG,gDAAiC,AAAO,QAAC,AAAa,0CAA6B,AAAO,QAAC,AAAoB,6CAAyB,AAAO,QAAC,AAAkB,kBAAQ,WAAG,AAAQ,SAAC,AAAS,UAAC,AAAW,AAAC;AAE5P,YAAM,AAAO,UAAG,MAAM,AAA2B,4CAAC,AAAO,QAAC,AAAO,SAAE,AAAI,OAAC,AAAQ,AAAC;;AACjF,UAAI,AAAO,WAAI,AAAI,MAAE;AACnB,AAAQ,mBAAG,AAAQ,SAAC,AAAS,UAAC,AAAC,GAAE,AAAW,AAAC,AAAG,qCAAsB,AAAO,OAAO,UAAG,AAAQ,SAAC,AAAS,UAAC,AAAW,AAAC;AACvH;;AAED,AAAK,gCAAC,AAAQ,AAAC;AACf,YAAM,AAAS,2BAAC,AAAY,cAAE,AAAQ,AAAC,AACzC;;AAAC;;AAEa,AAAqB,uBAA3B,AAAK,CAAuB,AAAe,SAAE,AAAe;;;;AAClE,YAAM,AAAO,UAAG,AAAI,OAAC,AAAO;AAC5B,YAAM,AAAI,OAAG,CACX,AAAa,eAAE,AAAO,AACvB;AACD,AAAG,8BAAC,AAAI,OAAC,AAAO,QAAC,AAAe,mBAAI,AAAe,iBAAE,AAAE,AAAC,AAAE,MAAC,AAAI,KAAC,AAAI,KAAC,AAAoB,sBAAE,AAAG,AAAC,AAAC;;AAChG,UAAI,AAAO,QAAC,AAAO,WAAI,AAAI,MAAE;AAC3B,AAAI,aAAC,AAAI,KAAC,AAAW,aAAE,AAAI,KAAC,AAAO,QAAC,AAAI,OAAC,AAAQ,SAAC,AAAI,KAAC,AAAiB,mBAAE,AAAO,QAAC,AAAO,AAAC,AAAC;AAC5F,aACI,IAAI,AAAO,QAAC,AAAO,YAAK,AAAI,MAAE;AACjC,cAAM,AAAG,MAAG,AAAI,KAAC,AAAI,KAAC,AAAI,OAAC,AAAQ,SAAC,AAAI,KAAC,AAAiB,mBAAE,AAAa,AAAC;AAC1E,cAAM,AAAI,OAAG,MAAM,AAAU,sBAAC,AAAG,AAAC;;AAClC,YAAI,AAAI,QAAI,AAAI,QAAI,AAAI,KAAC,AAAW,AAAE,eAAE;AACtC,AAAI,eAAC,AAAI,KAAC,AAAW,aAAE,AAAG,AAAC;AAC5B;AACF;;AAED,AAAI,WAAC,AAAI,KAAC,AAAO,AAAC;AAClB,YAAM,AAAI,yBAAC,AAAU,YAAE,AAAI,AAAC,AAC9B;;AAAC,AACF,AAED,AAAM;;;;;;iCAAkC,AAAyB,UAAE,AAAmC;AACpG,QAAM,AAAI,OAAkB,AAAE;;AAC9B,MAAI,AAAQ,YAAI,AAAI,MAAE;AACpB,AAAI,SAAC,AAAI,KAAC,AAAQ,UAAE,AAAQ,SAAC,AAAI,AAAC;;AAClC,QAAI,AAAQ,YAAI,AAAI,MAAE;AACpB,AAAI,WAAC,AAAI,KAAC,AAAY,cAAE,AAAQ,AAAC;AAClC;AACF;;AACD,SAAO,AAAI,AACb;AAAC","sourcesContent":["import { Arch, debug, exec, use } from \"builder-util\"\nimport { statOrNull } from \"builder-util/out/fs\"\nimport { getNotLocalizedLicenseFiles } from \"builder-util/out/license\"\nimport { readFile, unlink, writeFile } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { PkgOptions } from \"..\"\nimport { filterCFBundleIdentifier } from \"../appInfo\"\nimport { findIdentity, Identity } from \"../codeSign\"\nimport { Target } from \"../core\"\nimport MacPackager from \"../macPackager\"\n\nconst certType = \"Developer ID Installer\"\n\n// http://www.shanekirk.com/2013/10/creating-flat-packages-in-osx/\n// to use --scripts, we must build .app bundle separately using pkgbuild\n// productbuild --scripts doesn't work (because scripts in this case not added to our package)\n// https://github.com/electron-userland/electron-osx-sign/issues/96#issuecomment-274986942\nexport class PkgTarget extends Target {\n  readonly options: PkgOptions = {\n    allowAnywhere: true,\n    allowCurrentUserHome: true,\n    allowRootDirectory: true,\n    ...this.packager.config.pkg,\n  }\n\n  constructor(private readonly packager: MacPackager, readonly outDir: string) {\n    super(\"pkg\")\n  }\n\n  async build(appPath: string, arch: Arch): Promise<any> {\n    const packager = this.packager\n    const options = this.options\n    const appInfo = packager.appInfo\n\n    const artifactName = packager.expandArtifactNamePattern(options, \"pkg\")\n    const artifactPath = path.join(this.outDir, artifactName)\n\n    this.logBuilding(\"pkg\", artifactPath, arch)\n\n    const keychainName = (await packager.codeSigningInfo.value).keychainName\n\n    const appOutDir = this.outDir\n    // https://developer.apple.com/library/content/documentation/DeveloperTools/Reference/DistributionDefinitionRef/Chapters/Distribution_XML_Ref.html\n    const distInfoFile = path.join(appOutDir, \"distribution.xml\")\n\n    const innerPackageFile = path.join(appOutDir, `${filterCFBundleIdentifier(appInfo.id)}.pkg`)\n    const identity = (await Promise.all([\n      findIdentity(certType, options.identity || packager.platformSpecificBuildOptions.identity, keychainName),\n      this.customizeDistributionConfiguration(distInfoFile, appPath),\n      this.buildComponentPackage(appPath, innerPackageFile),\n    ]))[0]\n\n    if (identity == null && packager.forceCodeSigning) {\n      throw new Error(`Cannot find valid \"${certType}\" to sign standalone installer, please see https://electron.build/code-signing`)\n    }\n\n    const args = prepareProductBuildArgs(identity, keychainName)\n    args.push(\"--distribution\", distInfoFile)\n    args.push(artifactPath)\n    use(options.productbuild, it => args.push(...it as any))\n    await exec(\"productbuild\", args, {\n      cwd: appOutDir,\n    })\n    await Promise.all([unlink(innerPackageFile), unlink(distInfoFile)])\n\n    packager.dispatchArtifactCreated(artifactPath, this, arch, packager.computeSafeArtifactName(artifactName, \"pkg\", arch))\n  }\n\n  private async customizeDistributionConfiguration(distInfoFile: string, appPath: string) {\n    await exec(\"productbuild\", [\"--synthesize\", \"--component\", appPath, distInfoFile], {\n      cwd: this.outDir,\n    })\n\n    const options = this.options\n    let distInfo = await readFile(distInfoFile, \"utf-8\")\n    const insertIndex = distInfo.lastIndexOf(\"</installer-gui-script>\")\n    distInfo = distInfo.substring(0, insertIndex) + `    <domains enable_anywhere=\"${options.allowAnywhere}\" enable_currentUserHome=\"${options.allowCurrentUserHome}\" enable_localSystem=\"${options.allowRootDirectory}\" />\\n` + distInfo.substring(insertIndex)\n\n    const license = await getNotLocalizedLicenseFiles(options.license, this.packager)\n    if (license != null) {\n      distInfo = distInfo.substring(0, insertIndex) + `    <license file=\"${license}\"/>\\n` + distInfo.substring(insertIndex)\n    }\n\n    debug(distInfo)\n    await writeFile(distInfoFile, distInfo)\n  }\n\n  private async buildComponentPackage(appPath: string, outFile: string) {\n    const options = this.options\n    const args = [\n      \"--component\", appPath,\n    ]\n    use(this.options.installLocation || \"/Applications\", it => args.push(\"--install-location\", it!))\n    if (options.scripts != null) {\n      args.push(\"--scripts\", path.resolve(this.packager.info.buildResourcesDir, options.scripts))\n    }\n    else if (options.scripts !== null) {\n      const dir = path.join(this.packager.info.buildResourcesDir, \"pkg-scripts\")\n      const stat = await statOrNull(dir)\n      if (stat != null && stat.isDirectory()) {\n        args.push(\"--scripts\", dir)\n      }\n    }\n\n    args.push(outFile)\n    await exec(\"pkgbuild\", args)\n  }\n}\n\nexport function prepareProductBuildArgs(identity: Identity | null, keychain: string | null | undefined): Array<string> {\n  const args: Array<string> = []\n  if (identity != null) {\n    args.push(\"--sign\", identity.hash)\n    if (keychain != null) {\n      args.push(\"--keychain\", keychain)\n    }\n  }\n  return args\n}"]}
