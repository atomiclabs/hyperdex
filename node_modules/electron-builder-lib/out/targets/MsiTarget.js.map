{"version":3,"file":"MsiTarget.js","sourceRoot":"","sources":["../../src/targets/MsiTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, log, deepAssign } from \"builder-util\"\nimport { UUID } from \"builder-util-runtime\"\nimport { getBinFromGithub } from \"builder-util/out/binDownload\"\nimport { walk } from \"builder-util/out/fs\"\nimport * as ejs from \"ejs\"\nimport { readFile, writeFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { MsiOptions } from \"../\"\nimport { Target } from \"../core\"\nimport { DesktopShortcutCreationPolicy, FinalCommonWindowsInstallerOptions, getEffectiveOptions } from \"../options/CommonWindowsInstallerConfiguration\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { VmManager } from \"../vm/vm\"\nimport { WineVmManager } from \"../vm/WineVm\"\nimport { WinPackager } from \"../winPackager\"\nimport { createStageDir } from \"./targetUtil\"\n\nconst ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID = UUID.parse(\"d752fe43-5d44-44d5-9fc9-6dd1bf19d5cc\")\nconst ROOT_DIR_ID = \"APPLICATIONFOLDER\"\n\nconst ASSISTED_UI_FILE_NAME = \"WixUI_Assisted.wxs\"\n\nconst projectTemplate = new Lazy<(data: any) => string>(async () => {\n  const template = (await readFile(path.join(getTemplatePath(\"msi\"), \"template.xml\"), \"utf8\"))\n    .replace(/{{/g, \"<%\")\n    .replace(/}}/g, \"%>\")\n    .replace(/\\${([^}]+)}/g, \"<%=$1%>\")\n  return ejs.compile(template)\n})\n\n// WiX doesn't support Mono, so, dontnet462 is required to be installed for wine (preinstalled in our bundled wine)\nexport default class MsiTarget extends Target {\n  private readonly vm = process.platform === \"win32\" ? new VmManager() : new WineVmManager()\n\n  readonly options: MsiOptions = deepAssign(this.packager.platformSpecificBuildOptions, this.packager.config.msi)\n\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\n    super(\"msi\")\n  }\n\n  async build(appOutDir: string, arch: Arch) {\n    const packager = this.packager\n    const artifactName = packager.expandArtifactNamePattern(this.options, \"msi\", arch)\n    const artifactPath = path.join(this.outDir, artifactName)\n    this.logBuilding(\"MSI\", artifactPath, arch)\n\n    const stageDir = await createStageDir(this, packager, arch)\n    const vm = this.vm\n\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n\n    if (commonOptions.isAssisted) {\n      // F*** *** ***  ***  ***  ***  ***  ***  ***  ***  ***  ***  *** WiX  ***  ***  ***  ***  ***  ***  ***  ***  ***\n      // cannot understand how to set MSIINSTALLPERUSER on radio box change. In any case installed per user.\n      log.warn(`MSI DOESN'T SUPPORT assisted installer. Please use NSIS instead.`)\n    }\n\n    const projectFile = stageDir.getTempFile(\"project.wxs\")\n    const objectFiles = [\"project.wixobj\"]\n    const uiFile = commonOptions.isAssisted ?  stageDir.getTempFile(ASSISTED_UI_FILE_NAME) : null\n    await writeFile(projectFile, await this.writeManifest(appOutDir, arch, commonOptions))\n    if (uiFile !== null) {\n      await writeFile(uiFile, await readFile(path.join(getTemplatePath(\"msi\"), ASSISTED_UI_FILE_NAME), \"utf8\"))\n      objectFiles.push(ASSISTED_UI_FILE_NAME.replace(\".wxs\", \".wixobj\"))\n    }\n\n    // noinspection SpellCheckingInspection\n    const vendorPath = await getBinFromGithub(\"wix\", \"4.0.0.5512.2\", \"/X5poahdCc3199Vt6AP7gluTlT1nxi9cbbHhZhCMEu+ngyP1LiBMn+oZX7QAZVaKeBMc2SjVp7fJqNLqsUnPNQ==\")\n\n    // noinspection SpellCheckingInspection\n    const candleArgs = [\n      \"-arch\", arch === Arch.ia32 ? \"x86\" : (arch === Arch.armv7l ? \"arm\" : \"x64\"),\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n    ].concat(this.getCommonWixArgs())\n    candleArgs.push(\"project.wxs\")\n    if (uiFile !== null) {\n      candleArgs.push(ASSISTED_UI_FILE_NAME)\n    }\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"candle.exe\")), candleArgs, {\n      cwd: stageDir.dir,\n    })\n\n    await this.light(objectFiles, vm, artifactPath, appOutDir, vendorPath, stageDir.dir)\n\n    await stageDir.cleanup()\n\n    await packager.sign(artifactPath)\n\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      packager,\n      arch,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"msi\"),\n      target: this,\n      isWriteUpdateInfo: false,\n    })\n  }\n\n  private async light(objectFiles: Array<string>, vm: VmManager, artifactPath: string, appOutDir: string, vendorPath: string, tempDir: string) {\n    // noinspection SpellCheckingInspection\n    const lightArgs = [\n      \"-out\", vm.toVmFile(artifactPath),\n      \"-v\",\n      // https://github.com/wixtoolset/issues/issues/5169\n      \"-spdb\",\n      // https://sourceforge.net/p/wix/bugs/2405/\n      // error LGHT1076 : ICE61: This product should remove only older versions of itself. The Maximum version is not less than the current product. (1.1.0.42 1.1.0.42)\n      \"-sw1076\",\n      `-dappDir=${vm.toVmFile(appOutDir)}`,\n      // \"-dcl:high\",\n    ].concat(this.getCommonWixArgs())\n\n    // http://windows-installer-xml-wix-toolset.687559.n2.nabble.com/Build-3-5-2229-0-give-me-the-following-error-error-LGHT0216-An-unexpected-Win32-exception-with-errorn-td5707443.html\n    if (process.platform !== \"win32\") {\n      // noinspection SpellCheckingInspection\n      lightArgs.push(\"-sval\")\n    }\n\n    if (this.options.oneClick === false) {\n      lightArgs.push(\"-ext\", \"WixUIExtension\")\n    }\n\n    // objectFiles - only filenames, we set current directory to our temp stage dir\n    lightArgs.push(...objectFiles)\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"light.exe\")), lightArgs, {\n      cwd: tempDir,\n    })\n  }\n\n  private getCommonWixArgs() {\n    const args: Array<string> = [\"-pedantic\"]\n    if (this.options.warningsAsErrors !== false) {\n      args.push(\"-wx\")\n    }\n    return args\n  }\n\n  private async writeManifest(appOutDir: string, arch: Arch, commonOptions: FinalCommonWindowsInstallerOptions) {\n    const appInfo = this.packager.appInfo\n    const {files, dirs} = await this.computeFileDeclaration(appOutDir)\n\n    const companyName = appInfo.companyName\n    if (!companyName) {\n      log.warn(`Manufacturer is not set for MSI — please set \"author\" in the package.json`)\n    }\n\n    const compression = this.packager.compression\n    const options = this.options\n    const iconPath = await this.packager.getIconPath()\n    return (await projectTemplate.value)({\n      ...commonOptions,\n      isCreateDesktopShortcut: commonOptions.isCreateDesktopShortcut !== DesktopShortcutCreationPolicy.NEVER,\n      isRunAfterFinish: options.runAfterFinish !== false,\n      iconPath: iconPath == null ? null : this.vm.toVmFile(iconPath),\n      compressionLevel: compression === \"store\" ? \"none\" : \"high\",\n      version: appInfo.versionInWeirdWindowsForm,\n      productName: appInfo.productName,\n      upgradeCode: (options.upgradeCode || UUID.v5(appInfo.id, ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID)).toUpperCase(),\n      manufacturer: companyName || appInfo.productName,\n      appDescription: appInfo.description,\n      // https://stackoverflow.com/questions/1929038/compilation-error-ice80-the-64bitcomponent-uses-32bitdirectory\n      programFilesId: arch === Arch.x64 ? \"ProgramFiles64Folder\" : \"ProgramFilesFolder\",\n      // wix in the name because special wix format can be used in the name\n      installationDirectoryWixName: /^[-_+0-9a-zA-Z ]+$/.test(appInfo.productFilename) ? appInfo.productFilename : appInfo.sanitizedName,\n      dirs,\n      files,\n    })\n  }\n\n  private async computeFileDeclaration(appOutDir: string) {\n    const appInfo = this.packager.appInfo\n    let isRootDirAddedToRemoveTable = false\n    const dirNames = new Set<string>()\n    const dirs: Array<string> = []\n    const fileSpace = \" \".repeat(6)\n    const commonOptions = getEffectiveOptions(this.options, this.packager)\n    const files = await BluebirdPromise.map(walk(appOutDir), file => {\n      const packagePath = file.substring(appOutDir.length + 1)\n\n      const lastSlash = packagePath.lastIndexOf(path.sep)\n      const fileName = lastSlash > 0 ? packagePath.substring(lastSlash + 1) : packagePath\n      let directoryId: string | null = null\n      let dirName = \"\"\n      // Wix Directory.FileSource doesn't work - https://stackoverflow.com/questions/21519388/wix-filesource-confusion\n      if (lastSlash > 0) {\n        // This Name attribute may also define multiple directories using the inline directory syntax.\n        // For example, \"ProgramFilesFolder:\\My Company\\My Product\\bin\" would create a reference to a Directory element with Id=\"ProgramFilesFolder\" then create directories named \"My Company\" then \"My Product\" then \"bin\" nested beneath each other.\n        // This syntax is a shortcut to defining each directory in an individual Directory element.\n        dirName = packagePath.substring(0, lastSlash)\n        // add U (user) suffix just to be sure that will be not overwrite system WIX directory ids.\n        directoryId = \"d\" + Buffer.from(dirName).toString(\"base64\").replace(/\\//g, \"_\").replace(/\\+/g, \".\").replace(/\\=+$/, \"\")\n        if (!dirNames.has(dirName)) {\n          dirNames.add(dirName)\n          dirs.push(`<Directory Id=\"${directoryId}\" Name=\"${ROOT_DIR_ID}:\\\\${dirName.replace(/\\//g, \"\\\\\")}\\\\\"/>`)\n        }\n      }\n      else if (!isRootDirAddedToRemoveTable) {\n        isRootDirAddedToRemoveTable = true\n      }\n\n      // since RegistryValue can be part of Component, *** *** *** *** *** *** *** *** *** wix cannot auto generate guid\n      // https://stackoverflow.com/questions/1405100/change-my-component-guid-in-wix\n      let result = `<Component${directoryId === null ? \"\" : ` Directory=\"${directoryId}\"`}>`\n      result += `\\n${fileSpace}  <File Name=\"${fileName}\" Source=\"$(var.appDir)${path.sep}${packagePath}\" ReadOnly=\"yes\" KeyPath=\"yes\"`\n      const isMainExecutable = packagePath === `${appInfo.productFilename}.exe`\n      if (isMainExecutable) {\n        result += ' Id=\"mainExecutable\"'\n      }\n      else if (directoryId === null) {\n        result += ` Id=\"${path.basename(packagePath)}_f\"`\n      }\n\n      const isCreateDesktopShortcut = commonOptions.isCreateDesktopShortcut !== DesktopShortcutCreationPolicy.NEVER\n      if (isMainExecutable && (isCreateDesktopShortcut || commonOptions.isCreateStartMenuShortcut)) {\n        result += `>\\n`\n        const shortcutName = commonOptions.shortcutName\n        if (isCreateDesktopShortcut) {\n          result += `${fileSpace}  <Shortcut Id=\"desktopShortcut\" Directory=\"DesktopFolder\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\"/>\\n`\n        }\n\n        const hasMenuCategory = commonOptions.menuCategory != null\n        const startMenuShortcutDirectoryId = hasMenuCategory ? \"AppProgramMenuDir\" : \"ProgramMenuFolder\"\n        if (commonOptions.isCreateStartMenuShortcut) {\n          if (hasMenuCategory) {\n            dirs.push(`<Directory Id=\"${startMenuShortcutDirectoryId}\" Name=\"ProgramMenuFolder:\\\\${commonOptions.menuCategory}\\\\\"/>`)\n          }\n          result += `${fileSpace}  <Shortcut Id=\"startMenuShortcut\" Directory=\"${startMenuShortcutDirectoryId}\" Name=\"${shortcutName}\" WorkingDirectory=\"APPLICATIONFOLDER\" Advertise=\"yes\" Icon=\"icon.ico\"/>\\n`\n        }\n        result += `${fileSpace}</File>`\n\n        if (hasMenuCategory) {\n          result += `<RemoveFolder Id=\"${startMenuShortcutDirectoryId}\" On=\"uninstall\"/>\\n`\n        }\n      }\n      else {\n        result += `/>`\n      }\n\n      return `${result}\\n${fileSpace}</Component>`\n    })\n\n    return {dirs: listToString(dirs, 2), files: listToString(files, 3)}\n  }\n}\n\nfunction listToString(list: Array<string>, indentLevel:  number) {\n  const space = \" \".repeat(indentLevel * 2)\n  return list.join(`\\n${space}`)\n}"]}
