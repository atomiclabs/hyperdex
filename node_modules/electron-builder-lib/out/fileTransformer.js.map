{"version":3,"file":"fileTransformer.js","sourceRoot":"","sources":["../src/fileTransformer.ts"],"names":[],"mappings":"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","sourcesContent":["import { debug, log, deepAssign } from \"builder-util\"\nimport { FileTransformer } from \"builder-util/out/fs\"\nimport { readFile } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { Configuration } from \"./configuration\"\nimport { Packager } from \"./packager\"\n\n/** @internal */\nexport const NODE_MODULES_PATTERN = `${path.sep}node_modules${path.sep}`\n\n/** @internal */\nexport function isElectronCompileUsed(info: Packager): boolean {\n  if (info.config.electronCompile != null) {\n    return info.config.electronCompile\n  }\n\n  // if in devDependencies - it means that babel is used for precompilation or for some reason user decided to not use electron-compile for production\n  return hasDep(\"electron-compile\", info)\n}\n\n/** @internal */\nexport function hasDep(name: string, info: Packager) {\n  const deps = info.metadata.dependencies\n  return deps != null && name in deps\n}\n\n/** @internal */\nexport function createTransformer(srcDir: string, configuration: Configuration, extraMetadata: any, extraTransformer: FileTransformer | null): FileTransformer {\n  const mainPackageJson = path.join(srcDir, \"package.json\")\n  const isRemovePackageScripts = configuration.removePackageScripts !== false\n  const packageJson = path.sep + \"package.json\"\n  return file => {\n    if (file === mainPackageJson) {\n      return modifyMainPackageJson(file, extraMetadata, isRemovePackageScripts)\n    }\n\n    if (file.endsWith(packageJson) && file.includes(NODE_MODULES_PATTERN)) {\n      return readFile(file, \"utf-8\")\n        .then(it => cleanupPackageJson(JSON.parse(it), {\n          isMain: false,\n          isRemovePackageScripts,\n        }))\n        .catch(e => log.warn(e))\n    }\n    else if (extraTransformer != null) {\n      return extraTransformer(file)\n    }\n    else {\n      return null\n    }\n  }\n}\n\n/** @internal */\nexport interface CompilerHost {\n  compile(file: string): any\n\n  saveConfiguration(): Promise<any>\n}\n\n/** @internal */\nexport function createElectronCompilerHost(projectDir: string, cacheDir: string): Promise<CompilerHost> {\n  const electronCompilePath = path.join(projectDir, \"node_modules\", \"electron-compile\", \"lib\")\n  return require(path.join(electronCompilePath, \"config-parser\")).createCompilerHostFromProjectRoot(projectDir, cacheDir)\n}\n\nconst ignoredPackageMetadataProperties = new Set([\"dist\", \"gitHead\", \"keywords\", \"build\", \"jspm\", \"ava\", \"xo\", \"nyc\", \"eslintConfig\", \"contributors\", \"bundleDependencies\", \"tags\"])\n\ninterface CleanupPackageFileOptions {\n  readonly isRemovePackageScripts: boolean\n  readonly isMain: boolean\n}\n\nfunction cleanupPackageJson(data: any, options: CleanupPackageFileOptions): any {\n  const deps = data.dependencies\n  // https://github.com/electron-userland/electron-builder/issues/507#issuecomment-312772099\n  const isRemoveBabel = deps != null && typeof deps === \"object\" && !Object.getOwnPropertyNames(deps).some(it => it.startsWith(\"babel\"))\n  try {\n    let changed = false\n    for (const prop of Object.getOwnPropertyNames(data)) {\n      // removing devDependencies from package.json breaks levelup in electron, so, remove it only from main package.json\n      if (prop[0] === \"_\" ||\n        ignoredPackageMetadataProperties.has(prop) ||\n        (options.isRemovePackageScripts && prop === \"scripts\") ||\n        (options.isMain && prop === \"devDependencies\") ||\n        (!options.isMain && prop === \"bugs\") ||\n        (isRemoveBabel && prop === \"babel\")) {\n        delete data[prop]\n        changed = true\n      }\n    }\n\n    if (changed) {\n      return JSON.stringify(data, null, 2)\n    }\n  }\n  catch (e) {\n    debug(e)\n  }\n\n  return null\n}\n\nasync function modifyMainPackageJson(file: string, extraMetadata: any, isRemovePackageScripts: boolean) {\n  const mainPackageData = JSON.parse(await readFile(file, \"utf-8\"))\n  if (extraMetadata != null) {\n    deepAssign(mainPackageData, extraMetadata)\n  }\n\n  // https://github.com/electron-userland/electron-builder/issues/1212\n  const serializedDataIfChanged = cleanupPackageJson(mainPackageData, {\n    isMain: true,\n    isRemovePackageScripts,\n  })\n  if (serializedDataIfChanged != null) {\n    return serializedDataIfChanged\n  }\n  else if (extraMetadata != null) {\n    return JSON.stringify(mainPackageData, null, 2)\n  }\n  return null\n}"]}
