{"version":3,"file":"asar.js","sourceRoot":"","sources":["../../src/asar/asar.ts"],"names":[],"mappings":"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","sourcesContent":["import { createFromBuffer } from \"chromium-pickle-js\"\nimport { close, open, read, readFile, Stats } from \"fs-extra-p\"\nimport * as path from \"path\"\n\n/** @internal */\nexport class Node {\n  // we don't use Map because later it will be stringified\n  files?: { [key: string]: Node }\n\n  unpacked?: boolean\n\n  size?: number\n  // electron expects string\n  offset?: string\n\n  executable?: boolean\n\n  link?: string\n}\n\n/** @internal */\nexport class AsarFilesystem {\n  private offset = 0\n\n  constructor(readonly src: string, readonly header = new Node(), readonly headerSize: number = -1) {\n    if (this.header.files == null) {\n      this.header.files = {}\n    }\n  }\n\n  searchNodeFromDirectory(p: string, isCreate: boolean): Node | null {\n    let node = this.header\n    for (const dir of p.split(path.sep)) {\n      if (dir !== \".\") {\n        let child = node.files![dir]\n        if (child == null) {\n          if (!isCreate) {\n            return null\n          }\n          child = new Node()\n          child.files = {}\n          node.files![dir] = child\n        }\n        node = child\n      }\n    }\n    return node\n  }\n\n  getOrCreateNode(p: string): Node {\n    if (p == null || p.length === 0) {\n      return this.header\n    }\n\n    const name = path.basename(p)\n    const dirNode = this.searchNodeFromDirectory(path.dirname(p), true)!\n    if (dirNode.files == null) {\n      dirNode.files = {}\n    }\n\n    let result = dirNode.files[name]\n    if (result == null) {\n      result = new Node()\n      dirNode.files[name] = result\n    }\n    return result\n  }\n\n  addFileNode(file: string, dirNode: Node, size: number, unpacked: boolean, stat: Stats): Node {\n    if (size > 4294967295) {\n      throw new Error(`${file}: file size cannot be larger than 4.2GB`)\n    }\n\n    const node = new Node()\n    node.size = size\n    if (unpacked) {\n      node.unpacked = true\n    }\n    else {\n      // electron expects string\n      node.offset = this.offset.toString()\n      if (process.platform !== \"win32\" && (stat.mode & 0o100)) {\n        node.executable = true\n      }\n      this.offset += node.size\n    }\n\n    let children = dirNode.files\n    if (children == null) {\n      children = {}\n      dirNode.files = children\n    }\n    children[path.basename(file)] = node\n\n    return node\n  }\n\n  getNode(p: string) {\n    const node = this.searchNodeFromDirectory(path.dirname(p), false)!\n    return node.files![path.basename(p)]\n  }\n\n  getFile(p: string, followLinks: boolean = true): Node {\n    const info = this.getNode(p)!\n    // if followLinks is false we don't resolve symlinks\n    return followLinks && info.link != null ? this.getFile(info.link) : info\n  }\n\n  async readJson(file: string): Promise<any> {\n    return JSON.parse((await this.readFile(file)).toString())\n  }\n\n  async readFile(file: string): Promise<Buffer> {\n    return await readFileFromAsar(this, file, this.getFile(file))\n  }\n}\n\nexport async function readAsar(archive: string): Promise<AsarFilesystem> {\n  const fd = await open(archive, \"r\")\n  let size\n  let headerBuf\n  try {\n    const sizeBuf = Buffer.allocUnsafe(8)\n    if (await read(fd, sizeBuf, 0, 8, null as any) !== 8) {\n      throw new Error(\"Unable to read header size\")\n    }\n\n    const sizePickle = createFromBuffer(sizeBuf)\n    size = sizePickle.createIterator().readUInt32()\n    headerBuf = Buffer.allocUnsafe(size)\n    if (await read(fd, headerBuf, 0, size, null as any) !== size) {\n      throw new Error(\"Unable to read header\")\n    }\n  }\n  finally {\n    await close(fd)\n  }\n\n  const headerPickle = createFromBuffer(headerBuf!)\n  const header = headerPickle.createIterator().readString()\n  return new AsarFilesystem(archive, JSON.parse(header), size)\n}\n\nexport async function readAsarJson(archive: string, file: string): Promise<any> {\n  const fs = await readAsar(archive)\n  return await fs.readJson(file)\n}\n\nasync function readFileFromAsar(filesystem: AsarFilesystem, filename: string, info: Node): Promise<Buffer> {\n  const size = info.size!!\n  const buffer = Buffer.allocUnsafe(size)\n  if (size <= 0) {\n    return buffer\n  }\n\n  if (info.unpacked) {\n    return await readFile(path.join(`${filesystem.src}.unpacked`, filename))\n  }\n\n  const fd = await open(filesystem.src, \"r\")\n  try {\n    const offset = 8 + filesystem.headerSize + parseInt(info.offset!!, 10)\n    await read(fd, buffer, 0, size, offset)\n  }\n  finally {\n    await close(fd)\n  }\n  return buffer\n}\n"]}
