{"version":3,"file":"fileMatcher.js","sourceRoot":"","sources":["../src/fileMatcher.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { asArray, log } from \"builder-util\"\nimport { copyDir, copyOrLinkFile, Filter, statOrNull } from \"builder-util/out/fs\"\nimport { mkdirs } from \"fs-extra-p\"\nimport { Minimatch } from \"minimatch\"\nimport * as path from \"path\"\nimport { Platform } from \"./core\"\nimport { Configuration, FileSet, PlatformSpecificBuildOptions } from \"./index\"\nimport { PlatformPackager } from \"./platformPackager\"\nimport { createFilter, hasMagic } from \"./util/filter\"\n\n// https://github.com/electron-userland/electron-builder/issues/733\nconst minimatchOptions = {dot: true}\n\n// noinspection SpellCheckingInspection\nexport const excludedNames = \".git,.hg,.svn,CVS,RCS,SCCS,\" +\n  \"__pycache__,.DS_Store,thumbs.db,.gitignore,.gitkeep,.gitattributes,.npmignore,\" +\n  \".idea,.vs,.flowconfig,.jshintrc,.eslintrc,.circleci,\" +\n  \".yarn-integrity,.yarn-metadata.json,yarn-error.log,yarn.lock,package-lock.json,npm-debug.log,\" +\n  \"appveyor.yml,.travis.yml,circle.yml,.nyc_output\"\n\n/** @internal */\nexport class FileMatcher {\n  readonly from: string\n  readonly to: string\n\n  readonly patterns: Array<string>\n\n  excludePatterns: Array<Minimatch> | null = null\n\n  readonly isSpecifiedAsEmptyArray: boolean\n\n  constructor(from: string, to: string, readonly macroExpander: (pattern: string) => string, patterns?: Array<string> | string | null | undefined) {\n    this.from = macroExpander(from)\n    this.to = macroExpander(to)\n    this.patterns = asArray(patterns).map(it => this.normalizePattern(it))\n    this.isSpecifiedAsEmptyArray = Array.isArray(patterns) && patterns.length === 0\n  }\n\n  normalizePattern(pattern: string) {\n    if (pattern.startsWith(\"./\")) {\n      pattern = pattern.substring(\"./\".length)\n    }\n    return path.posix.normalize(this.macroExpander(pattern.replace(/\\\\/g, \"/\")))\n  }\n\n  addPattern(pattern: string) {\n    this.patterns.push(this.normalizePattern(pattern))\n  }\n\n  prependPattern(pattern: string) {\n    this.patterns.unshift(this.normalizePattern(pattern))\n  }\n\n  isEmpty() {\n    return this.patterns.length === 0\n  }\n\n  containsOnlyIgnore(): boolean {\n    return !this.isEmpty() && this.patterns.find(it => !it.startsWith(\"!\")) == null\n  }\n\n  computeParsedPatterns(result: Array<Minimatch>, fromDir?: string): void {\n    const relativeFrom = fromDir == null ? null : path.relative(fromDir, this.from)\n\n    if (this.patterns.length === 0 && relativeFrom != null) {\n      // file mappings, from here is a file\n      result.push(new Minimatch(relativeFrom, minimatchOptions))\n      return\n    }\n\n    for (let pattern of this.patterns) {\n      if (relativeFrom != null) {\n        pattern = path.join(relativeFrom, pattern)\n      }\n\n      const parsedPattern = new Minimatch(pattern, minimatchOptions)\n      result.push(parsedPattern)\n\n      // do not add if contains dot (possibly file if has extension)\n      if (!pattern.includes(\".\") && !hasMagic(parsedPattern)) {\n        // https://github.com/electron-userland/electron-builder/issues/545\n        // add **/*\n        result.push(new Minimatch(`${pattern}/**/*`, minimatchOptions))\n      }\n    }\n  }\n\n  createFilter(): Filter {\n    const parsedPatterns: Array<Minimatch> = []\n    this.computeParsedPatterns(parsedPatterns)\n    return createFilter(this.from, parsedPatterns, this.excludePatterns)\n  }\n\n  toString() {\n    return `from: ${this.from}, to: ${this.to}, patterns: ${this.patterns.join(\", \")}`\n  }\n}\n\n/** @internal */\nexport function getMainFileMatchers(appDir: string, destination: string, macroExpander: (pattern: string) => string, platformSpecificBuildOptions: PlatformSpecificBuildOptions, platformPackager: PlatformPackager<any>, outDir: string, isElectronCompile: boolean): Array<FileMatcher> {\n  const packager = platformPackager.info\n  const buildResourceDir = path.resolve(packager.projectDir, packager.buildResourcesDir)\n\n  let matchers = packager.isPrepackedAppAsar ? null : getFileMatchers(packager.config, \"files\", appDir, destination, {\n    macroExpander,\n    customBuildOptions: platformSpecificBuildOptions,\n    outDir,\n  })\n  if (matchers == null) {\n    matchers = [new FileMatcher(appDir, destination, macroExpander)]\n  }\n\n  const matcher = matchers[0]\n  // add default patterns, but only if from equals to app dir\n  if (matcher.from !== appDir) {\n    return matchers\n  }\n\n  // https://github.com/electron-userland/electron-builder/issues/1741#issuecomment-311111418 so, do not use inclusive patterns\n  const patterns = matcher.patterns\n\n  const customFirstPatterns: Array<string> = []\n  // electron-webpack - we need to copy only package.json and node_modules from root dir (and these files are added by default), so, explicit empty array is specified\n  if (!matcher.isSpecifiedAsEmptyArray && (matcher.isEmpty() || matcher.containsOnlyIgnore())) {\n    customFirstPatterns.push(\"**/*\")\n  }\n  else {\n    // prependPattern - user pattern should be after to be able to override\n    // do not use **/node_modules/**/* because if pattern starts with **, all not explicitly excluded directories will be traversed (performance + empty dirs will be included into the asar)\n    customFirstPatterns.push(\"node_modules/**/*\")\n    if (!patterns.includes(\"package.json\")) {\n      patterns.push(\"package.json\")\n    }\n  }\n\n  // https://github.com/electron-userland/electron-builder/issues/1482\n  const relativeBuildResourceDir = path.relative(matcher.from, buildResourceDir)\n  if (relativeBuildResourceDir.length !== 0 && !relativeBuildResourceDir.startsWith(\".\")) {\n    customFirstPatterns.push(`!${relativeBuildResourceDir}{,/**/*}`)\n  }\n\n  const relativeOutDir = matcher.normalizePattern(path.relative(packager.projectDir, outDir))\n  if (!relativeOutDir.startsWith(\".\")) {\n    customFirstPatterns.push(`!${relativeOutDir}{,/**/*}`)\n  }\n\n  // add our default exclusions after last user possibly defined \"all\"/permissive pattern\n  let insertIndex = 0\n  for (let i = patterns.length - 1; i >= 0; i--) {\n    if (patterns[i].startsWith(\"**/\")) {\n      insertIndex = i + 1\n      break\n    }\n  }\n  patterns.splice(insertIndex, 0, ...customFirstPatterns)\n\n  // not moved to copyNodeModules because depends on platform packager (for now, not easy)\n  if (platformPackager.platform !== Platform.WINDOWS) {\n    // https://github.com/electron-userland/electron-builder/issues/1738\n    patterns.push(\"!**/node_modules/**/*.{dll,exe}\")\n  }\n\n  patterns.push(`!**/*.{iml,hprof,orig,pyc,pyo,rbc,swp,csproj,sln,suo,xproj,cc${packager.config.includePdb === true ? \"\" : \",pdb\"}`)\n  patterns.push(\"!**/._*\")\n  patterns.push(\"!**/electron-builder.{yaml,yml,json,json5,toml}\")\n  //noinspection SpellCheckingInspection\n  patterns.push(`!**/{${excludedNames}}`)\n\n  if (isElectronCompile) {\n    patterns.push(\"!.cache{,/**/*}\")\n  }\n\n  // https://github.com/electron-userland/electron-builder/issues/1969\n  // exclude ony for app root, use .yarnclean to clean node_modules\n  patterns.push(\"!.editorconfig\")\n\n  const debugLogger = packager.debugLogger\n  if (debugLogger.enabled) {\n    //tslint:disable-next-line:no-invalid-template-strings\n    debugLogger.add(`${macroExpander(\"${arch}\")}.firstOrDefaultFilePatterns`, patterns)\n  }\n  return matchers\n}\n\nexport interface GetFileMatchersOptions {\n  readonly macroExpander: (pattern: string) => string\n  readonly customBuildOptions: PlatformSpecificBuildOptions\n  readonly outDir: string\n}\n\n/** @internal */\nexport function getFileMatchers(config: Configuration, name: \"files\" | \"extraFiles\" | \"extraResources\" | \"asarUnpack\", defaultSrc: string, defaultDestination: string, options: GetFileMatchersOptions): Array<FileMatcher> | null {\n  const globalPatterns: Array<string | FileSet> | string | null | undefined | FileSet = (config as any)[name]\n  const platformSpecificPatterns: Array<string | FileSet> | string | null | undefined = (options.customBuildOptions as any)[name]\n\n  const defaultMatcher = new FileMatcher(defaultSrc, defaultDestination, options.macroExpander)\n  const fileMatchers: Array<FileMatcher> = []\n\n  function addPatterns(patterns: Array<string | FileSet> | string | null | undefined | FileSet) {\n    if (patterns == null) {\n      return\n    }\n    else if (!Array.isArray(patterns)) {\n      if (typeof patterns === \"string\") {\n        defaultMatcher.addPattern(patterns)\n        return\n      }\n      patterns = [patterns]\n    }\n\n    for (const pattern of patterns) {\n      if (typeof pattern === \"string\") {\n        // use normalize to transform ./foo to foo\n        defaultMatcher.addPattern(pattern)\n      }\n      else if (name === \"asarUnpack\") {\n        throw new Error(`Advanced file copying not supported for \"${name}\"`)\n      }\n      else {\n        const from = pattern.from == null ? defaultSrc : path.resolve(defaultSrc, pattern.from)\n        const to = pattern.to == null ? defaultDestination : path.resolve(defaultDestination, pattern.to)\n        fileMatchers.push(new FileMatcher(from, to, options.macroExpander, pattern.filter))\n      }\n    }\n  }\n\n  addPatterns(globalPatterns)\n  addPatterns(platformSpecificPatterns)\n\n  if (!defaultMatcher.isEmpty()) {\n    // default matcher should be first in the array\n    fileMatchers.unshift(defaultMatcher)\n  }\n\n  // we cannot exclude the whole out dir, because sometimes users want to use some file in the out dir in the patterns\n  const relativeOutDir = defaultMatcher.normalizePattern(path.relative(defaultSrc, options.outDir))\n  if (!relativeOutDir.startsWith(\".\")) {\n    defaultMatcher.addPattern(`!${relativeOutDir}/*-unpacked{,/**/*}`)\n  }\n\n  return fileMatchers.length === 0 ? null : fileMatchers\n}\n\n/** @internal */\nexport function copyFiles(matchers: Array<FileMatcher> | null): Promise<any> {\n  if (matchers == null || matchers.length === 0) {\n    return Promise.resolve()\n  }\n\n  return BluebirdPromise.map(matchers, async (matcher: FileMatcher) => {\n    const fromStat = await statOrNull(matcher.from)\n    if (fromStat == null) {\n      log.warn({from: matcher.from}, `file source doesn't exist`)\n      return\n    }\n\n    if (fromStat.isFile()) {\n      const toStat = await statOrNull(matcher.to)\n      // https://github.com/electron-userland/electron-builder/issues/1245\n      if (toStat != null && toStat.isDirectory()) {\n        return await copyOrLinkFile(matcher.from, path.join(matcher.to, path.basename(matcher.from)), fromStat)\n      }\n\n      await mkdirs(path.dirname(matcher.to))\n      return await copyOrLinkFile(matcher.from, matcher.to, fromStat)\n    }\n\n    if (matcher.isEmpty() || matcher.containsOnlyIgnore()) {\n      matcher.prependPattern(\"**/*\")\n    }\n    log.debug({matcher}, \"copying files using pattern\")\n    return await copyDir(matcher.from, matcher.to, {filter: matcher.createFilter()})\n  })\n}"]}
