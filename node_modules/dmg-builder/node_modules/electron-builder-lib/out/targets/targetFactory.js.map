{"version":3,"file":"targetFactory.js","sourceRoot":"","sources":["../../src/targets/targetFactory.ts"],"names":[],"mappings":"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","sourcesContent":["import { addValue, Arch, archFromString, ArchType, asArray } from \"builder-util\"\nimport { PlatformSpecificBuildOptions, DEFAULT_TARGET, DIR_TARGET, Platform, Target, TargetConfiguration } from \"../index\"\nimport { PlatformPackager } from \"../platformPackager\"\nimport { ArchiveTarget } from \"./ArchiveTarget\"\n\nconst archiveTargets = new Set([\"zip\", \"7z\", \"tar.xz\", \"tar.lz\", \"tar.gz\", \"tar.bz2\"])\n\nexport function computeArchToTargetNamesMap(raw: Map<Arch, Array<string>>, options: PlatformSpecificBuildOptions, platform: Platform): Map<Arch, Array<string>> {\n  for (const targetNames of raw.values()) {\n    if (targetNames.length > 0) {\n      // https://github.com/electron-userland/electron-builder/issues/1355\n      return raw\n    }\n  }\n\n  const defaultArchs: Array<ArchType> = raw.size === 0 ? [platform === Platform.MAC ? \"x64\" : process.arch as ArchType] : Array.from(raw.keys()).map(it => Arch[it] as ArchType)\n  const result = new Map(raw)\n  for (const target of asArray(options.target).map<TargetConfiguration>(it => typeof it === \"string\" ? {target: it} : it)) {\n    let name = target.target\n    let archs = target.arch\n    const suffixPos = name.lastIndexOf(\":\")\n    if (suffixPos > 0) {\n      name = target.target.substring(0, suffixPos)\n      if (archs == null) {\n        archs = target.target.substring(suffixPos + 1) as ArchType\n      }\n    }\n\n    for (const arch of archs == null ? defaultArchs : asArray(archs)) {\n      addValue(result, archFromString(arch), name)\n    }\n  }\n\n  if (result.size === 0) {\n    for (const arch of defaultArchs) {\n      result.set(archFromString(arch), [])\n    }\n  }\n\n  return result\n}\n\nexport function createTargets(nameToTarget: Map<string, Target>, rawList: Array<string>, outDir: string, packager: PlatformPackager<any>): Array<Target> {\n  const result: Array<Target> = []\n\n  const mapper = (name: string, factory: (outDir: string) => Target) => {\n    let target = nameToTarget.get(name)\n    if (target == null) {\n      target = factory(outDir)\n      nameToTarget.set(name, target)\n    }\n    result.push(target)\n  }\n\n  const targets = normalizeTargets(rawList, packager.defaultTarget)\n  packager.createTargets(targets, mapper)\n  return result\n}\n\nfunction normalizeTargets(targets: Array<string>, defaultTarget: Array<string>): Array<string> {\n  const list: Array<string> = []\n  for (const t of targets) {\n    const name = t.toLowerCase().trim()\n    if (name === DEFAULT_TARGET) {\n      list.push(...defaultTarget)\n    }\n    else {\n      list.push(name)\n    }\n  }\n  return list\n}\n\nexport function createCommonTarget(target: string, outDir: string, packager: PlatformPackager<any>): Target {\n  if (archiveTargets.has(target)) {\n    return new ArchiveTarget(target, outDir, packager)\n  }\n  else if (target === DIR_TARGET) {\n    return new NoOpTarget(DIR_TARGET)\n  }\n  else {\n    throw new Error(`Unknown target: ${target}`)\n  }\n}\n\nexport class NoOpTarget extends Target {\n  readonly options = null\n\n  constructor(name: string) {\n    super(name)\n  }\n\n  get outDir(): string {\n    throw new Error(\"NoOpTarget\")\n  }\n\n  async build(appOutDir: string, arch: Arch): Promise<any> {\n    // no build\n  }\n}"]}
