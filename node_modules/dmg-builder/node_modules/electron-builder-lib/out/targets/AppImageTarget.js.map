{"version":3,"file":"AppImageTarget.js","sourceRoot":"","sources":["../../src/targets/AppImageTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, serializeToYaml, executeAppBuilder } from \"builder-util\"\nimport { UUID } from \"builder-util-runtime\"\nimport { copyOrLinkFile, unlinkIfExists } from \"builder-util/out/fs\"\nimport * as ejs from \"ejs\"\nimport { ensureDir, outputFile, readFile, symlink, writeFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { AppImageOptions } from \"..\"\nimport { Target } from \"../core\"\nimport { LinuxPackager } from \"../linuxPackager\"\nimport { getAppUpdatePublishConfiguration } from \"../publish/PublishManager\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport { LinuxTargetHelper } from \"./LinuxTargetHelper\"\nimport { createStageDir } from \"./targetUtil\"\n\nconst appRunTemplate = new Lazy<(data: any) => string>(async () => {\n  return ejs.compile(await readFile(path.join(getTemplatePath(\"linux\"), \"AppRun.sh\"), \"utf-8\"))\n})\n\n// https://unix.stackexchange.com/questions/375191/append-to-sub-directory-inside-squashfs-file\nexport default class AppImageTarget extends Target {\n  readonly options: AppImageOptions = {...this.packager.platformSpecificBuildOptions, ...(this.packager.config as any)[this.name]}\n  private readonly desktopEntry: Lazy<string>\n\n  constructor(ignored: string, private readonly packager: LinuxPackager, private readonly helper: LinuxTargetHelper, readonly outDir: string) {\n    super(\"appImage\")\n\n    // we add X-AppImage-BuildId to ensure that new desktop file will be installed\n    this.desktopEntry = new Lazy<string>(() => helper.computeDesktopEntry(this.options, \"AppRun\", {\n      \"X-AppImage-Version\": `${packager.appInfo.buildVersion}`,\n      \"X-AppImage-BuildId\": UUID.v1(),\n    }))\n  }\n\n  async build(appOutDir: string, arch: Arch): Promise<any> {\n    const packager = this.packager\n    // https://github.com/electron-userland/electron-builder/issues/775\n    // https://github.com/electron-userland/electron-builder/issues/1726\n    // tslint:disable-next-line:no-invalid-template-strings\n    const artifactName = packager.expandArtifactNamePattern(this.options, \"AppImage\", arch, \"${name}-${version}-${arch}.${ext}\", false)\n    const artifactPath = path.join(this.outDir, artifactName)\n    this.logBuilding(\"AppImage\", artifactPath, arch)\n\n    const stageDir = await createStageDir(this, packager, arch)\n    const resourceName = `appimagekit-${this.packager.executableName}`\n    const installIcons = await this.copyIcons(stageDir.dir, resourceName)\n\n    const finalDesktopFilename = `${this.packager.executableName}.desktop`\n    await Promise.all([\n      unlinkIfExists(artifactPath),\n      writeFile(stageDir.getTempFile(\"/AppRun\"), (await appRunTemplate.value)({\n        systemIntegration: this.options.systemIntegration || \"ask\",\n        desktopFileName: finalDesktopFilename,\n        executableName: this.packager.executableName,\n        resourceName,\n        installIcons,\n      }), {\n        mode: \"0755\",\n      }),\n      writeFile(stageDir.getTempFile(finalDesktopFilename), await this.desktopEntry.value),\n    ])\n\n    // must be after this.helper.icons call\n    if (this.helper.maxIconPath == null) {\n      throw new Error(\"Icon is not provided\")\n    }\n\n    if (this.packager.packagerOptions.effectiveOptionComputed != null && await this.packager.packagerOptions.effectiveOptionComputed({desktop: await this.desktopEntry.value})) {\n      return\n    }\n\n    const publishConfig = await getAppUpdatePublishConfiguration(packager, arch, false /* in any case validation will be done on publish */)\n    if (publishConfig != null) {\n      await outputFile(path.join(packager.getResourcesDir(stageDir.getTempFile(\"app\")), \"app-update.yml\"), serializeToYaml(publishConfig))\n    }\n\n    const args = [\"appimage\", \"--stage\", stageDir.dir, \"--arch\", Arch[arch], \"--output\", artifactPath, \"--app\", appOutDir]\n    if (packager.compression === \"maximum\") {\n      args.push(\"--compression\", \"xz\")\n    }\n\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"AppImage\", arch, false),\n      target: this,\n      arch,\n      packager,\n      isWriteUpdateInfo: true,\n      updateInfo: JSON.parse(await executeAppBuilder(args)),\n    })\n  }\n\n  private async copyIcons(stageDir: string, resourceName: string): Promise<string> {\n    const iconDirRelativePath = \"usr/share/icons/hicolor\"\n    const iconDir = path.join(stageDir, iconDirRelativePath)\n    await ensureDir(iconDir)\n\n    // https://github.com/AppImage/AppImageKit/issues/438#issuecomment-319094239\n    // expects icons in the /usr/share/icons/hicolor\n    const iconNames = await BluebirdPromise.map(this.helper.icons, async icon => {\n      const filename = `${this.packager.executableName}.png`\n      const iconSizeDir = `${icon.size}x${icon.size}/apps`\n      const dir = path.join(iconDir, iconSizeDir)\n      await ensureDir(dir)\n      const finalIconFile = path.join(dir, filename)\n      await copyOrLinkFile(icon.file, finalIconFile, null, true)\n\n      if (icon.file === this.helper.maxIconPath) {\n        await symlink(path.relative(stageDir, finalIconFile), path.join(stageDir, filename))\n      }\n      return {filename, iconSizeDir, size: icon.size}\n    })\n\n    let installIcons = \"\"\n    for (const icon of iconNames) {\n      installIcons += `xdg-icon-resource install --noupdate --context apps --size ${icon.size} \"$APPDIR/${iconDirRelativePath}/${icon.iconSizeDir}/${icon.filename}\" \"${resourceName}\"\\n`\n    }\n    return installIcons\n  }\n}"]}
