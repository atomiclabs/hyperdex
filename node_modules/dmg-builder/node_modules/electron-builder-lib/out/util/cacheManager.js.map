{"version":3,"file":"cacheManager.js","sourceRoot":"","sources":["../../src/util/cacheManager.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { Arch, log } from \"builder-util\"\nimport { copyFile } from \"builder-util/out/fs\"\nimport { orNullIfFileNotExist } from \"builder-util/out/promise\"\nimport { Hash } from \"crypto\"\nimport { ensureDir, readFile, readJson, writeJson } from \"fs-extra-p\"\nimport * as path from \"path\"\n\nexport interface BuildCacheInfo {\n  executableDigest: string\n}\n\nexport class BuildCacheManager {\n  static VERSION: string = \"0\"\n\n  readonly cacheDir: string\n  readonly cacheInfoFile: string\n  readonly cacheFile: string\n\n  cacheInfo: BuildCacheInfo | null = null\n\n  private newDigest: string | null = null\n\n  constructor(outDir: string, private readonly executableFile: string, arch: Arch) {\n    this.cacheDir = path.join(outDir, \".cache\", Arch[arch])\n    this.cacheFile = path.join(this.cacheDir, \"app.exe\")\n    this.cacheInfoFile = path.join(this.cacheDir, \"info.json\")\n  }\n\n  async copyIfValid(digest: string): Promise<boolean> {\n    this.newDigest = digest\n\n    this.cacheInfo = await orNullIfFileNotExist(readJson(this.cacheInfoFile))\n    const oldDigest = this.cacheInfo == null ? null : this.cacheInfo.executableDigest\n    if (oldDigest !== digest) {\n      log.debug({oldDigest, newDigest: digest}, \"no valid cached executable found\")\n      return false\n    }\n\n    log.debug({cacheFile: this.cacheFile, file: this.executableFile}, `copying cached executable`)\n    try {\n      await copyFile(this.cacheFile, this.executableFile, false)\n      return true\n    }\n    catch (e) {\n      if (e.code === \"ENOENT\" || e.code === \"ENOTDIR\") {\n        log.debug({error: e.code}, \"copy cached executable failed\")\n      }\n      else {\n        log.warn({error: e.stack || e}, `cannot copy cached executable`)\n      }\n    }\n    return false\n  }\n\n  async save() {\n    if (this.newDigest == null) {\n      throw new Error(\"call copyIfValid before\")\n    }\n\n    if (this.cacheInfo == null) {\n      this.cacheInfo = {executableDigest: this.newDigest}\n    }\n    else {\n      this.cacheInfo.executableDigest = this.newDigest\n    }\n\n    try {\n      await ensureDir(this.cacheDir)\n      await Promise.all([writeJson(this.cacheInfoFile, this.cacheInfo), copyFile(this.executableFile, this.cacheFile, false)])\n    }\n    catch (e) {\n      log.warn({error: e.stack || e}, `cannot save build cache`)\n    }\n  }\n}\n\nexport async function digest(hash: Hash, files: Array<string>) {\n  // do not use pipe - better do bulk file read (https://github.com/yarnpkg/yarn/commit/7a63e0d23c46a4564bc06645caf8a59690f04d01)\n  for (const content of await BluebirdPromise.map(files, it => readFile(it))) {\n    hash.update(content)\n  }\n\n  hash.update(BuildCacheManager.VERSION)\n  return hash.digest(\"base64\")\n}"]}
