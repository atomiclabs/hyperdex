{"version":3,"file":"packageMetadata.js","sourceRoot":"","sources":["../../src/util/packageMetadata.ts"],"names":[],"mappings":"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","sourcesContent":["import { isEmptyOrSpaces, log } from \"builder-util\"\nimport { readFile, readJson } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport * as semver from \"semver\"\nimport { Metadata } from \"..\"\n\nconst normalizeData = require(\"normalize-package-data\")\n\n/** @internal */\nexport async function readPackageJson(file: string): Promise<any> {\n  const data = await readJson(file)\n  await authors(file, data)\n  normalizeData(data)\n  return data\n}\n\nasync function authors(file: string, data: any) {\n  if (data.contributors != null) {\n    return\n  }\n\n  let authorData\n  try {\n    authorData = await readFile(path.resolve(path.dirname(file), \"AUTHORS\"), \"utf8\")\n  }\n  catch (ignored) {\n    return\n  }\n\n  data.contributors = authorData\n    .split(/\\r?\\n/g)\n    .map(it => it.replace(/^\\s*#.*$/, \"\").trim())\n}\n\n/** @internal */\nexport function checkMetadata(metadata: Metadata, devMetadata: any | null, appPackageFile: string, devAppPackageFile: string): void {\n  const errors: Array<string> = []\n  const reportError = (missedFieldName: string) => {\n    errors.push(`Please specify '${missedFieldName}' in the package.json (${appPackageFile})`)\n  }\n\n  const checkNotEmpty = (name: string, value: string | null | undefined) => {\n    if (isEmptyOrSpaces(value)) {\n      reportError(name)\n    }\n  }\n\n  if ((metadata as any).directories != null) {\n    errors.push(`\"directories\" in the root is deprecated, please specify in the \"build\"`)\n  }\n\n  checkNotEmpty(\"name\", metadata.name)\n\n  if (isEmptyOrSpaces(metadata.description)) {\n    log.warn({appPackageFile}, `description is missed in the package.json`)\n  }\n  if (metadata.author == null) {\n    log.warn({appPackageFile}, `author is missed in the package.json`)\n  }\n  checkNotEmpty(\"version\", metadata.version)\n\n  if (metadata != null) {\n    checkDependencies(metadata.dependencies, errors)\n  }\n  if (metadata !== devMetadata) {\n    if (metadata.build != null) {\n      errors.push(`'build' in the application package.json (${appPackageFile}) is not supported since 3.0 anymore. Please move 'build' into the development package.json (${devAppPackageFile})`)\n    }\n  }\n\n  const devDependencies = (metadata as any).devDependencies\n  if (devDependencies != null && \"electron-rebuild\" in devDependencies) {\n    log.info('electron-rebuild not required if you use electron-builder, please consider to remove excess dependency from devDependencies\\n\\nTo ensure your native dependencies are always matched electron version, simply add script `\"postinstall\": \"electron-builder install-app-deps\" to your `package.json`')\n  }\n\n  if (errors.length > 0) {\n    throw new Error(errors.join(\"\\n\"))\n  }\n}\n\nexport function versionFromDependencyRange(version: string) {\n  const firstChar = version[0]\n  return firstChar === \"^\" || firstChar === \"~\" ? version.substring(1) : version\n}\n\nfunction checkDependencies(dependencies: { [key: string]: string } | null | undefined, errors: Array<string>) {\n  if (dependencies == null) {\n    return\n  }\n\n  const updaterVersion = dependencies[\"electron-updater\"]\n  if (updaterVersion != null && !semver.satisfies(versionFromDependencyRange(updaterVersion), \">=2.18.2\")) {\n    errors.push(`At least electron-updater 2.18.2 is required by current electron-builder version. Please set electron-updater version to \"^2.18.2\"`)\n  }\n\n  const deps = [\"electron\", \"electron-prebuilt\", \"electron-rebuild\"]\n  if (process.env.ALLOW_ELECTRON_BUILDER_AS_PRODUCTION_DEPENDENCY !== \"true\") {\n    deps.push(\"electron-builder\")\n  }\n  for (const name of deps) {\n    if (name in dependencies) {\n      errors.push(`Package \"${name}\" is only allowed in \"devDependencies\". `\n        + `Please remove it from the \"dependencies\" section in your package.json.`)\n    }\n  }\n}"]}
